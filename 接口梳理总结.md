# analyDesign 接口梳理总结

## 📋 系统架构概述

analyDesign 采用**双服务器架构**，提供完整的需求分析和文档处理服务：

- **HTTP API 服务器** (`src/apis/api_server.py`) - 端口 **8082**
- **WebSocket 服务器** (`src/websockets/websocket_server.py`) - 端口 **8081**
- **主启动器** (`run.py`) - 支持多种启动模式

## 🌐 HTTP API 接口 (端口 8082)

### 1. 基础信息接口

#### 1.1 服务首页
```http
GET /
```
**功能**: 获取服务基本信息和所有可用端点  
**响应**: 服务信息、版本、可用端点列表、功能特性

#### 1.2 健康检查
```http
GET /api/health
```
**功能**: 检查服务状态和依赖服务连接状态  
**响应**: 服务健康状态、火山引擎连接状态

### 2. 聊天对话接口

#### 2.1 聊天接口
```http
POST /api/chat
Content-Type: application/json
```
**请求体**:
```json
{
  "message": "用户消息内容",
  "session_id": "可选的会话ID"
}
```
**功能**: 与AI助手进行对话交互  
**响应**: AI回复、会话ID、置信度、意图识别

### 3. 会话管理接口

#### 3.1 获取所有会话
```http
GET /api/sessions
```
**功能**: 获取所有会话列表和消息历史

#### 3.2 获取特定会话
```http
GET /api/sessions/{session_id}
```
**功能**: 获取指定会话的详细信息

#### 3.3 删除会话
```http
DELETE /api/sessions/{session_id}
```
**功能**: 删除指定会话及其消息历史

### 4. 文件处理接口

#### 4.1 文件上传
```http
POST /api/file/upload
```
**支持格式**:
- `application/json` - Base64编码文件内容
- `multipart/form-data` - 传统文件上传

**功能**: 上传文档文件并开始解析任务  
**响应**: 任务ID、文件信息、文件路径

#### 4.2 获取解析状态
```http
GET /api/file/parsing/{task_id}
```
**功能**: 获取文件解析进度和状态  
**响应**: 解析状态、进度、步骤详情、解析结果

#### 4.3 内容分析
```http
POST /api/file/analyze/{task_id}
```
**功能**: 对已解析文档进行内容分析  
**前置条件**: 文档解析完成  
**响应**: 分析任务启动确认

#### 4.4 AI智能分析
```http
POST /api/file/ai-analyze/{task_id}
```
**请求体**:
```json
{
  "analysis_type": "comprehensive|summary|requirements|custom",
  "custom_prompt": "自定义分析提示（可选）"
}
```
**功能**: 对内容分析结果进行AI智能分析  
**前置条件**: 内容分析完成  
**响应**: AI分析任务启动确认

#### 4.5 获取完整分析结果
```http
GET /api/file/result/{task_id}
```
**功能**: 获取三个接口的整合分析结果  
**响应**: 
- 文档解析结果
- 内容分析结果  
- AI分析结果
- 整体状态和进度

#### 4.6 获取文件列表
```http
GET /api/file/list
```
**功能**: 获取所有已上传文件的列表和状态

#### 4.7 删除文件
```http
DELETE /api/file/delete/{task_id}
```
**功能**: 删除已上传文件及其分析结果

### 5. 错误处理

#### 5.1 404 错误
**响应**: 接口不存在提示

#### 5.2 500 错误
**响应**: 服务器内部错误提示

## 🔌 WebSocket 实时通信接口 (端口 8081)

### 1. 连接管理事件

#### 1.1 连接建立
**事件**: `connect`  
**服务器响应**: `connected`
```json
{
  "status": "success",
  "client_id": "client_sid",
  "message": "连接成功",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

#### 1.2 断开连接
**事件**: `disconnect`  
**功能**: 客户端断开连接时触发，服务器清理连接信息

#### 1.3 心跳检测
**客户端发送**: `ping`  
**服务器响应**: `pong`
```json
{
  "timestamp": "2025-01-15T10:30:00Z",
  "client_id": "client_sid"
}
```

### 2. 聊天通信事件

#### 2.1 发送聊天消息
**客户端发送**: `chat`
```json
{
  "message": "用户消息内容",
  "session_id": "可选的会话ID"
}
```

**服务器响应**: `chat_processing`
```json
{
  "session_id": "session_id",
  "message": "正在处理您的消息...",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

**服务器响应**: `chat_response`
```json
{
  "success": true,
  "response": "AI助手的回复内容",
  "session_id": "session_id",
  "timestamp": "2025-01-15T10:30:05Z",
  "confidence": 0.9,
  "intent": "需求分析",
  "model": "doubao-pro-4k"
}
```

### 3. 文件处理事件

#### 3.1 文件上传进度
**客户端发送**: `file_upload_progress`
```json
{
  "task_id": "uuid",
  "progress": 50,
  "status": "uploading"
}
```

**服务器广播**: `file_progress_update`
```json
{
  "task_id": "uuid",
  "progress": 50,
  "status": "uploading",
  "timestamp": "2025-01-15T10:30:03Z"
}
```

### 4. 状态查询事件

#### 4.1 获取服务器状态
**客户端发送**: `get_status`  
**服务器响应**: `status_response`
```json
{
  "server_status": "running",
  "connected_clients": 5,
  "volcano_engine_status": "connected",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

### 5. 错误处理事件

#### 5.1 错误通知
**服务器发送**: `error`
```json
{
  "error": "错误描述信息",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

## 🚀 启动配置

### 1. 主启动器 (run.py)

#### 1.1 启动模式
```bash
python run.py --mode=full     # 完整服务 (API + WebSocket)
python run.py --mode=api      # 仅API服务器
python run.py --mode=websocket # 仅WebSocket服务器
```

#### 1.2 服务地址
- **API服务器**: `http://localhost:8082`
- **WebSocket服务器**: `ws://localhost:8081/socket.io/`

### 2. 批处理启动 (start_back.bat)

#### 2.1 启动选项
1. 完整服务 (API + WebSocket) - 推荐
2. 仅API服务器 (端口8082)
3. 仅WebSocket服务器 (端口8081)

## 📊 接口状态码

### HTTP 状态码
- `200 OK`: 请求成功
- `400 Bad Request`: 请求参数错误
- `404 Not Found`: 接口不存在
- `500 Internal Server Error`: 服务器内部错误

### 业务状态码
- `success: true`: 业务操作成功
- `success: false`: 业务操作失败

## 🔄 数据流程

### 文件分析流程
1. **文件上传** → `POST /api/file/upload`
2. **文档解析** → `GET /api/file/parsing/{task_id}`
3. **内容分析** → `POST /api/file/analyze/{task_id}`
4. **AI分析** → `POST /api/file/ai-analyze/{task_id}`
5. **获取结果** → `GET /api/file/result/{task_id}`

### 实时通信流程
1. **建立连接** → `connect` 事件
2. **心跳检测** → `ping/pong` 事件
3. **消息交互** → `chat` 事件
4. **状态更新** → `file_upload_progress` 事件
5. **断开连接** → `disconnect` 事件

## 🛠️ 技术特性

### API服务器特性
- ✅ RESTful API设计
- ✅ CORS跨域支持
- ✅ 文件上传处理
- ✅ 异步任务处理
- ✅ 火山引擎AI集成
- ✅ 会话管理
- ✅ 错误处理

### WebSocket服务器特性
- ✅ 实时双向通信
- ✅ 连接状态管理
- ✅ 心跳检测
- ✅ 文件上传进度跟踪
- ✅ 错误处理
- ✅ 多客户端支持

### 前端集成特性
- ✅ Vue 3 + Pinia状态管理
- ✅ WebSocket自动重连
- ✅ 文件拖拽上传
- ✅ 实时进度显示
- ✅ Markdown报告生成
- ✅ 响应式界面设计

## 📝 使用示例

### 1. 基础聊天
```javascript
// HTTP API方式
const response = await fetch('http://localhost:8082/api/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    message: '请帮我分析这个需求文档',
    session_id: 'session_123'
  })
});

// WebSocket方式
socket.emit('chat', {
  message: '请帮我分析这个需求文档',
  session_id: 'session_123'
});
```

### 2. 文件上传分析
```javascript
// 1. 上传文件
const uploadResponse = await fetch('http://localhost:8082/api/file/upload', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    file_info: {
      name: 'requirements.docx',
      content: base64Content,
      type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      size: fileSize
    }
  })
});

const { task_id } = uploadResponse.json();

// 2. 检查解析状态
const parsingStatus = await fetch(`http://localhost:8082/api/file/parsing/${task_id}`);

// 3. 启动内容分析
await fetch(`http://localhost:8082/api/file/analyze/${task_id}`, { method: 'POST' });

// 4. 启动AI分析
await fetch(`http://localhost:8082/api/file/ai-analyze/${task_id}`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ analysis_type: 'comprehensive' })
});

// 5. 获取完整结果
const result = await fetch(`http://localhost:8082/api/file/result/${task_id}`);
```

## 🔧 配置要求

### 环境依赖
- Python 3.8+
- Flask + Flask-SocketIO
- 火山引擎API密钥
- Node.js 16+ (前端)

### 配置文件
- `config.yaml` - 主配置文件
- `src/resource/config.py` - 配置管理模块

### 必要目录
- `uploads/` - 文件上传目录
- `logs/` - 日志目录
- `outputs/` - 输出目录
- `templates/` - 模板目录

---

**总计接口数量**: 
- HTTP API接口: **13个**
- WebSocket事件: **8个**
- 启动模式: **3种**

**服务端口**:
- API服务器: **8082**
- WebSocket服务器: **8081** 