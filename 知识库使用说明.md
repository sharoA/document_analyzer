# 知识库使用说明

## 概述

本项目已成功将 `D:\knowledge_base` 下的知识库内容转换为向量并存储到 Weaviate 向量数据库中。支持对各种文件类型进行智能搜索和查询。

## 已处理的文件类型

- **📄 DOCX 文件**: Word 文档，按段落分割并提取文本内容
- **📊 XLSX 文件**: Excel 表格，提取表头和数据行内容
- **☕ Java 文件**: Java 源代码，按类和方法进行分割
- **⚙️ XML 文件**: 配置文件，按文本块分割

## 知识库统计

- **总文件数**: 577 个
  - DOCX: 34 个文件
  - XLSX: 6 个文件  
  - Java: 502 个文件
  - XML: 35 个文件
- **总文档块数**: 16,688 个
- **向量维度**: 384 (使用 all-MiniLM-L6-v2 模型)

## 使用方法

### 1. 交互式查询

运行查询脚本进行交互式搜索：

```bash
python query_knowledge_base.py
```

### 2. 编程方式查询

```python
from src.utils.knowledge_init_weaviate import KnowledgeBaseInitializer

# 创建初始化器
initializer = KnowledgeBaseInitializer()

# 执行查询
results = initializer.query_knowledge_base("查询内容", limit=5)

# 处理结果
for result in results:
    print(f"文件: {result['file_name']}")
    print(f"项目: {result['project']}")
    print(f"相似度: {1 - result['distance']:.3f}")
    print(f"内容: {result['content'][:100]}...")

# 关闭连接
initializer.close()
```

## 查询示例

### 数据库相关查询
```
查询: "LS中的数据库表结构"
结果: 找到审单模块表字段信息、还款清分表等相关内容
```

### 代码相关查询
```
查询: "用户管理相关的代码"
查询: "Java类的定义"
结果: 找到相关的Java类和方法定义
```

### 配置文件查询
```
查询: "链数后端的配置文件"
结果: 找到相关的配置和需求文档
```

## 项目结构识别

系统会自动从文件路径中提取项目名称，主要识别的项目包括：
- **链数_LS**: 链数后端项目
- **zqyl-ls**: 链数相关子项目
- 其他根据目录结构自动识别的项目

## 缓存机制

- 使用 Redis 缓存文件处理结果，避免重复处理
- 缓存有效期: 24小时
- 支持增量更新

## 配置信息

### Weaviate 配置
- 地址: localhost:8080
- 集合名称: KnowledgeDocument
- 认证: API Key (root-user-key)

### Redis 配置
- 地址: localhost:6379
- 用于缓存文件处理结果

### 嵌入模型
- 模型: all-MiniLM-L6-v2
- 维度: 384
- 支持中英文混合文本

## 文件说明

- `src/utils/knowledge_init_weaviate.py`: 知识库初始化脚本
- `query_knowledge_base.py`: 交互式查询脚本
- `src/utils/weaviate_helper.py`: Weaviate 连接管理
- `src/utils/redis_util.py`: Redis 缓存管理

## 注意事项

1. **首次运行**: 需要下载嵌入模型，可能需要较长时间
2. **内存使用**: 处理大量文件时会占用较多内存
3. **网络连接**: 需要确保 Weaviate 和 Redis 服务正常运行
4. **文件编码**: 自动处理 UTF-8 编码，忽略编码错误

## 扩展功能

### 添加新文件类型

在 `KnowledgeBaseInitializer` 类中：

1. 在 `supported_extensions` 中添加新的文件扩展名
2. 实现对应的 `_process_xxx_file` 方法
3. 在 `process_files` 方法中添加处理逻辑

### 自定义查询

```python
# 按项目过滤查询
collection = initializer.weaviate_client.collections.get("KnowledgeDocument")
result = collection.query.near_vector(
    near_vector=query_embedding,
    where={"path": ["project"], "operator": "Equal", "valueText": "链数_LS"},
    limit=10
)
```

## 故障排除

### 常见问题

1. **连接失败**: 检查 Weaviate 和 Redis 服务状态
2. **查询无结果**: 检查查询关键词是否准确
3. **内存不足**: 减少批处理大小或增加系统内存
4. **模型下载失败**: 检查网络连接或使用代理

### 日志查看

系统会输出详细的处理日志，包括：
- 文件扫描进度
- 处理结果统计
- 错误信息和警告

## 性能优化

- **批量处理**: 默认批次大小为 100 个文档
- **并行处理**: 支持多线程文件处理
- **缓存策略**: 智能缓存避免重复计算
- **增量更新**: 支持只处理新增或修改的文件

## 更新知识库

如果需要更新知识库内容：

```bash
# 重新运行初始化脚本
python src/utils/knowledge_init_weaviate.py
```

系统会自动检测文件变化并进行增量更新。 