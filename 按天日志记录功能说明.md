# æŒ‰å¤©æ—¥å¿—è®°å½•åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æ‚¨çš„é¡¹ç›®å·²ç»å®ç°äº†å®Œå–„çš„æŒ‰å¤©ç»´åº¦æ—¥å¿—è®°å½•åŠŸèƒ½ï¼Œç¡®ä¿åŒä¸€æ—¥æœŸçš„æ‰€æœ‰æ—¥å¿—éƒ½è®°å½•åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå¹¶æ”¯æŒè·¨å¤©è‡ªåŠ¨è½®è½¬ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. æŒ‰å¤©è‡ªåŠ¨åˆ†æ–‡ä»¶
- **æ–‡ä»¶å‘½åæ ¼å¼**: `llm_interactions_YYYYMMDD.log` å’Œ `llm_interactions_YYYYMMDD.json`
- **ç¤ºä¾‹**: 
  - `llm_interactions_20250530.log` (æ–‡æœ¬æ ¼å¼)
  - `llm_interactions_20250530.json` (JSONæ ¼å¼)

### 2. åŒæ ¼å¼åŒæ­¥è®°å½•
- **æ–‡æœ¬æ ¼å¼**: ä¾¿äºäººå·¥é˜…è¯»ï¼ŒåŒ…å«æ—¶é—´æˆ³å’Œæ ¼å¼åŒ–æ¶ˆæ¯
- **JSONæ ¼å¼**: ä¾¿äºç¨‹åºè§£æï¼ŒåŒ…å«å®Œæ•´çš„ç»“æ„åŒ–æ•°æ®

### 3. è‡ªåŠ¨æ—¥å¿—è½®è½¬
- **è·¨å¤©æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹æ—¥æœŸå˜åŒ–
- **æ–‡ä»¶åˆ‡æ¢**: é›¶ç‚¹åè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°çš„æ—¥å¿—æ–‡ä»¶
- **æ— ç¼è®°å½•**: ç¡®ä¿æ—¥å¿—è®°å½•ä¸ä¸­æ–­

## ğŸ”§ æŠ€æœ¯å®ç°

### æ ¸å¿ƒç»„ä»¶

#### 1. DailyRotatingFileHandler
```python
class DailyRotatingFileHandler(logging.FileHandler):
    """æŒ‰æ—¥æœŸè½®è½¬çš„æ–‡ä»¶å¤„ç†å™¨"""
    
    def _rotate_if_needed(self):
        """æ£€æŸ¥æ˜¯å¦éœ€è¦è½®è½¬æ–‡ä»¶"""
        current_date = self._get_current_date()
        if self.current_date != current_date:
            self.current_date = current_date
            self.current_filename = self.log_dir / self.filename_pattern.format(date=current_date)
            return True
        return False
```

#### 2. LLMLogger ä¸»ç±»
```python
class LLMLogger:
    """å¤§æ¨¡å‹äº¤äº’æ—¥å¿—è®°å½•å™¨"""
    
    def _setup_handlers(self):
        # æ–‡ä»¶å¤„ç†å™¨ - æ”¯æŒæŒ‰æ—¥è½®è½¬
        file_handler = DailyRotatingFileHandler(
            self.log_dir, 
            "llm_interactions_{date}.log"
        )
        
        # JSONå¤„ç†å™¨ - æ”¯æŒæŒ‰æ—¥è½®è½¬
        json_handler = DailyRotatingFileHandler(
            self.log_dir,
            "llm_interactions_{date}.json"
        )
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
logs/
â”œâ”€â”€ llm_interactions_20250530.log    # 5æœˆ30æ—¥çš„æ–‡æœ¬æ—¥å¿—
â”œâ”€â”€ llm_interactions_20250530.json   # 5æœˆ30æ—¥çš„JSONæ—¥å¿—
â”œâ”€â”€ llm_interactions_20250531.log    # 5æœˆ31æ—¥çš„æ–‡æœ¬æ—¥å¿—
â”œâ”€â”€ llm_interactions_20250531.json   # 5æœˆ31æ—¥çš„JSONæ—¥å¿—
â””â”€â”€ ...
```

## ğŸ“ æ—¥å¿—å†…å®¹æ ¼å¼

### æ–‡æœ¬æ—¥å¿—ç¤ºä¾‹
```
2025-05-30 18:32:09,149 - llm_interaction - INFO - ğŸš€ LLMè¯·æ±‚å¼€å§‹ - Provider: volcengine, Model: ep-20250528194304-wbvcf, ID: volcengine_1748601129149
2025-05-30 18:32:50,877 - llm_interaction - INFO - âœ… LLMè¯·æ±‚å®Œæˆ - ID: volcengine_1748601129149, è€—æ—¶: 41.73s, å“åº”é•¿åº¦: 1458å­—ç¬¦
```

### JSONæ—¥å¿—ç¤ºä¾‹
```json
{"type":"request","timestamp":"2025-05-30T18:32:09.149636","request_id":"volcengine_1748601129149","provider":"volcengine","model":"ep-20250528194304-wbvcf","messages":[{"role":"system","content":"ä½ æ˜¯analyDesignæ™ºèƒ½éœ€æ±‚åˆ†æåŠ©æ‰‹..."}],"parameters":{"temperature":0.7,"max_tokens":2000,"stream":false},"message_count":2,"total_chars":112}

{"type":"response","timestamp":"2025-05-30T18:32:50.877391","request_id":"volcengine_1748601129149","status":"success","response_time":41.72574305534363,"response_length":1458,"response_content":"æ‚¨å¥½ï¼æ„Ÿè°¢æ‚¨é€‰æ‹©analyDesign...","token_usage":{"prompt_tokens":60,"completion_tokens":1086,"total_tokens":1146},"error":null}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨
```python
from src.llm_logger import log_llm_request, log_llm_response

# è®°å½•è¯·æ±‚
request_id = log_llm_request(
    provider="volcengine",
    model="ep-20250528194304-wbvcf",
    messages=[{"role": "user", "content": "ä½ å¥½"}],
    parameters={"temperature": 0.7}
)

# è®°å½•å“åº”
log_llm_response(
    request_id=request_id,
    response_content="æ‚¨å¥½ï¼æˆ‘æ˜¯analyDesignåŠ©æ‰‹...",
    response_time=2.5,
    token_usage={"prompt_tokens": 10, "completion_tokens": 50, "total_tokens": 60}
)
```

### 2. é«˜çº§åŠŸèƒ½
```python
from src.llm_logger import get_llm_logger

# è·å–æ—¥å¿—è®°å½•å™¨å®ä¾‹
logger = get_llm_logger()

# è®°å½•æµå¼å“åº”å—
logger.log_stream_chunk(request_id, "éƒ¨åˆ†å“åº”å†…å®¹", chunk_index=1)

# è®°å½•ä¼šè¯æ€»ç»“
logger.log_conversation_summary(
    session_id="session_123",
    total_requests=5,
    total_response_time=15.2,
    total_tokens=500
)
```

## ğŸ“Š æ—¥å¿—è®°å½•ç±»å‹

### 1. è¯·æ±‚è®°å½• (type: "request")
- è¯·æ±‚IDã€æä¾›å•†ã€æ¨¡å‹
- æ¶ˆæ¯å†…å®¹ã€å‚æ•°é…ç½®
- æ¶ˆæ¯æ•°é‡ã€å­—ç¬¦ç»Ÿè®¡

### 2. å“åº”è®°å½• (type: "response")
- å“åº”å†…å®¹ã€å“åº”æ—¶é—´
- Tokenä½¿ç”¨ç»Ÿè®¡
- æˆåŠŸ/å¤±è´¥çŠ¶æ€

### 3. æµå¼å“åº”å— (type: "stream_chunk")
- å—ç´¢å¼•ã€å—å†…å®¹
- å—é•¿åº¦ç»Ÿè®¡

### 4. ä¼šè¯æ€»ç»“ (type: "session_summary")
- æ€»è¯·æ±‚æ•°ã€æ€»å“åº”æ—¶é—´
- å¹³å‡å“åº”æ—¶é—´ã€Tokenç»Ÿè®¡

## ğŸ” æ—¥å¿—åˆ†æ

### æŸ¥çœ‹ä»Šå¤©çš„æ—¥å¿—
```bash
# æŸ¥çœ‹æ–‡æœ¬æ—¥å¿—
cat logs/llm_interactions_$(date +%Y%m%d).log

# æŸ¥çœ‹JSONæ—¥å¿—
cat logs/llm_interactions_$(date +%Y%m%d).json
```

### JSONæ—¥å¿—è§£æç¤ºä¾‹
```python
import json
from datetime import datetime

def analyze_daily_logs(date_str):
    """åˆ†ææŒ‡å®šæ—¥æœŸçš„æ—¥å¿—"""
    json_file = f"logs/llm_interactions_{date_str}.json"
    
    requests = []
    responses = []
    
    with open(json_file, 'r', encoding='utf-8') as f:
        for line in f:
            if line.strip():
                data = json.loads(line.strip())
                if data['type'] == 'request':
                    requests.append(data)
                elif data['type'] == 'response':
                    responses.append(data)
    
    print(f"æ—¥æœŸ {date_str} ç»Ÿè®¡:")
    print(f"  æ€»è¯·æ±‚æ•°: {len(requests)}")
    print(f"  æˆåŠŸå“åº”: {len([r for r in responses if r['status'] == 'success'])}")
    print(f"  å¤±è´¥å“åº”: {len([r for r in responses if r['status'] == 'error'])}")

# åˆ†æä»Šå¤©çš„æ—¥å¿—
today = datetime.now().strftime('%Y%m%d')
analyze_daily_logs(today)
```

## âœ… ä¼˜åŠ¿ç‰¹ç‚¹

1. **æ•°æ®å®Œæ•´æ€§**: åŒä¸€å¤©çš„æ‰€æœ‰æ—¥å¿—éƒ½åœ¨åŒä¸€æ–‡ä»¶ä¸­
2. **è‡ªåŠ¨ç®¡ç†**: æ— éœ€æ‰‹åŠ¨åˆ›å»ºæˆ–åˆ‡æ¢æ—¥å¿—æ–‡ä»¶
3. **åŒæ ¼å¼æ”¯æŒ**: æ—¢ä¾¿äºäººå·¥æŸ¥çœ‹ï¼Œåˆä¾¿äºç¨‹åºåˆ†æ
4. **é«˜æ€§èƒ½**: ä½¿ç”¨ç¼“å†²å†™å…¥ï¼Œå‡å°‘I/Oå¼€é”€
5. **å®¹é”™æ€§**: å³ä½¿è·¨å¤©è¿è¡Œä¹Ÿèƒ½æ­£ç¡®å¤„ç†
6. **å¯æ‰©å±•**: æ”¯æŒæ·»åŠ æ–°çš„æ—¥å¿—ç±»å‹å’Œå­—æ®µ

## ğŸ› ï¸ æµ‹è¯•éªŒè¯

è¿è¡Œæ¼”ç¤ºè„šæœ¬éªŒè¯åŠŸèƒ½ï¼š
```bash
python demo_daily_logging.py
```

è¿™å°†åˆ›å»ºç¤ºä¾‹æ—¥å¿—å¹¶éªŒè¯æŒ‰å¤©è®°å½•åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

## ğŸ“ˆ æœªæ¥æ‰©å±•

å¯ä»¥è€ƒè™‘æ·»åŠ çš„åŠŸèƒ½ï¼š
- æ—¥å¿—å‹ç¼©å’Œå½’æ¡£
- æ—¥å¿—æ¸…ç†ç­–ç•¥
- æ—¥å¿—ç»Ÿè®¡æŠ¥å‘Š
- å®æ—¶æ—¥å¿—ç›‘æ§
- æ—¥å¿—æœç´¢å’Œè¿‡æ»¤

---

**æ€»ç»“**: æ‚¨çš„æ—¥å¿—ç³»ç»Ÿå·²ç»å®Œç¾å®ç°äº†æŒ‰å¤©ç»´åº¦è®°å½•çš„éœ€æ±‚ï¼Œç¡®ä¿åŒä¸€æ—¥æœŸçš„æ—¥å¿—éƒ½åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå¹¶æ”¯æŒè‡ªåŠ¨è½®è½¬å’ŒåŒæ ¼å¼è®°å½•ã€‚ 