# 按天日志记录功能说明

## 📋 功能概述

您的项目已经实现了完善的按天维度日志记录功能，确保同一日期的所有日志都记录在同一个文件中，并支持跨天自动轮转。

## 🎯 核心特性

### 1. 按天自动分文件
- **文件命名格式**: `llm_interactions_YYYYMMDD.log` 和 `llm_interactions_YYYYMMDD.json`
- **示例**: 
  - `llm_interactions_20250530.log` (文本格式)
  - `llm_interactions_20250530.json` (JSON格式)

### 2. 双格式同步记录
- **文本格式**: 便于人工阅读，包含时间戳和格式化消息
- **JSON格式**: 便于程序解析，包含完整的结构化数据

### 3. 自动日志轮转
- **跨天检测**: 自动检测日期变化
- **文件切换**: 零点后自动切换到新的日志文件
- **无缝记录**: 确保日志记录不中断

## 🔧 技术实现

### 核心组件

#### 1. DailyRotatingFileHandler
```python
class DailyRotatingFileHandler(logging.FileHandler):
    """按日期轮转的文件处理器"""
    
    def _rotate_if_needed(self):
        """检查是否需要轮转文件"""
        current_date = self._get_current_date()
        if self.current_date != current_date:
            self.current_date = current_date
            self.current_filename = self.log_dir / self.filename_pattern.format(date=current_date)
            return True
        return False
```

#### 2. LLMLogger 主类
```python
class LLMLogger:
    """大模型交互日志记录器"""
    
    def _setup_handlers(self):
        # 文件处理器 - 支持按日轮转
        file_handler = DailyRotatingFileHandler(
            self.log_dir, 
            "llm_interactions_{date}.log"
        )
        
        # JSON处理器 - 支持按日轮转
        json_handler = DailyRotatingFileHandler(
            self.log_dir,
            "llm_interactions_{date}.json"
        )
```

## 📁 文件结构

```
logs/
├── llm_interactions_20250530.log    # 5月30日的文本日志
├── llm_interactions_20250530.json   # 5月30日的JSON日志
├── llm_interactions_20250531.log    # 5月31日的文本日志
├── llm_interactions_20250531.json   # 5月31日的JSON日志
└── ...
```

## 📝 日志内容格式

### 文本日志示例
```
2025-05-30 18:32:09,149 - llm_interaction - INFO - 🚀 LLM请求开始 - Provider: volcengine, Model: ep-20250528194304-wbvcf, ID: volcengine_1748601129149
2025-05-30 18:32:50,877 - llm_interaction - INFO - ✅ LLM请求完成 - ID: volcengine_1748601129149, 耗时: 41.73s, 响应长度: 1458字符
```

### JSON日志示例
```json
{"type":"request","timestamp":"2025-05-30T18:32:09.149636","request_id":"volcengine_1748601129149","provider":"volcengine","model":"ep-20250528194304-wbvcf","messages":[{"role":"system","content":"你是analyDesign智能需求分析助手..."}],"parameters":{"temperature":0.7,"max_tokens":2000,"stream":false},"message_count":2,"total_chars":112}

{"type":"response","timestamp":"2025-05-30T18:32:50.877391","request_id":"volcengine_1748601129149","status":"success","response_time":41.72574305534363,"response_length":1458,"response_content":"您好！感谢您选择analyDesign...","token_usage":{"prompt_tokens":60,"completion_tokens":1086,"total_tokens":1146},"error":null}
```

## 🚀 使用方法

### 1. 基本使用
```python
from src.llm_logger import log_llm_request, log_llm_response

# 记录请求
request_id = log_llm_request(
    provider="volcengine",
    model="ep-20250528194304-wbvcf",
    messages=[{"role": "user", "content": "你好"}],
    parameters={"temperature": 0.7}
)

# 记录响应
log_llm_response(
    request_id=request_id,
    response_content="您好！我是analyDesign助手...",
    response_time=2.5,
    token_usage={"prompt_tokens": 10, "completion_tokens": 50, "total_tokens": 60}
)
```

### 2. 高级功能
```python
from src.llm_logger import get_llm_logger

# 获取日志记录器实例
logger = get_llm_logger()

# 记录流式响应块
logger.log_stream_chunk(request_id, "部分响应内容", chunk_index=1)

# 记录会话总结
logger.log_conversation_summary(
    session_id="session_123",
    total_requests=5,
    total_response_time=15.2,
    total_tokens=500
)
```

## 📊 日志记录类型

### 1. 请求记录 (type: "request")
- 请求ID、提供商、模型
- 消息内容、参数配置
- 消息数量、字符统计

### 2. 响应记录 (type: "response")
- 响应内容、响应时间
- Token使用统计
- 成功/失败状态

### 3. 流式响应块 (type: "stream_chunk")
- 块索引、块内容
- 块长度统计

### 4. 会话总结 (type: "session_summary")
- 总请求数、总响应时间
- 平均响应时间、Token统计

## 🔍 日志分析

### 查看今天的日志
```bash
# 查看文本日志
cat logs/llm_interactions_$(date +%Y%m%d).log

# 查看JSON日志
cat logs/llm_interactions_$(date +%Y%m%d).json
```

### JSON日志解析示例
```python
import json
from datetime import datetime

def analyze_daily_logs(date_str):
    """分析指定日期的日志"""
    json_file = f"logs/llm_interactions_{date_str}.json"
    
    requests = []
    responses = []
    
    with open(json_file, 'r', encoding='utf-8') as f:
        for line in f:
            if line.strip():
                data = json.loads(line.strip())
                if data['type'] == 'request':
                    requests.append(data)
                elif data['type'] == 'response':
                    responses.append(data)
    
    print(f"日期 {date_str} 统计:")
    print(f"  总请求数: {len(requests)}")
    print(f"  成功响应: {len([r for r in responses if r['status'] == 'success'])}")
    print(f"  失败响应: {len([r for r in responses if r['status'] == 'error'])}")

# 分析今天的日志
today = datetime.now().strftime('%Y%m%d')
analyze_daily_logs(today)
```

## ✅ 优势特点

1. **数据完整性**: 同一天的所有日志都在同一文件中
2. **自动管理**: 无需手动创建或切换日志文件
3. **双格式支持**: 既便于人工查看，又便于程序分析
4. **高性能**: 使用缓冲写入，减少I/O开销
5. **容错性**: 即使跨天运行也能正确处理
6. **可扩展**: 支持添加新的日志类型和字段

## 🛠️ 测试验证

运行演示脚本验证功能：
```bash
python demo_daily_logging.py
```

这将创建示例日志并验证按天记录功能是否正常工作。

## 📈 未来扩展

可以考虑添加的功能：
- 日志压缩和归档
- 日志清理策略
- 日志统计报告
- 实时日志监控
- 日志搜索和过滤

---

**总结**: 您的日志系统已经完美实现了按天维度记录的需求，确保同一日期的日志都在同一个文件中，并支持自动轮转和双格式记录。 