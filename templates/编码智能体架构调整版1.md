graph TB
    %% 顶部输入层
    subgraph "📋 输入层"
        direction LR
        ReqDoc["📄 需求文档<br/>- 功能需求<br/>- 业务规则<br/>- 接口定义<br/>- 微服务边界"]
        DesignDoc["📐 设计文档<br/>- 微服务架构<br/>- 服务依赖图<br/>- API契约<br/>- 数据模型"]
    end
    
    %% 第一层：任务拆分层
    subgraph "🧠 任务拆分调度层"
        direction LR
        
        subgraph "核心任务拆分器"
            TaskSplitAgent["任务拆分智能体<br/>🧠 核心决策器"]
            RequirementAnalyzer["需求分析器<br/>- 功能点提取<br/>- 业务逻辑分析<br/>- 微服务边界识别<br/>- 复杂度评估"]
            DesignAnalyzer["设计分析器<br/>- 架构模式识别<br/>- 服务依赖分析<br/>- 接口定义解析<br/>- 数据流分析"]
            TaskScheduler["任务调度器<br/>- 执行序列规划<br/>- 依赖关系排序<br/>- 并行任务识别<br/>- 资源分配策略"]
        end
        
        subgraph "任务管理"
            TaskQueue["任务队列<br/>- 优先级队列<br/>- 任务状态跟踪<br/>- 重试机制<br/>- 超时处理"]
            TaskPriority["任务优先级评估<br/>- 业务价值评分<br/>- 技术难度评估<br/>- 风险等级分析<br/>- 依赖紧急度"]
            ServiceTaskMap["服务任务映射<br/>- 微服务任务分组<br/>- 并行任务识别<br/>- 依赖任务排序"]
        end
    end
    
    %% 第二层：LangGraph控制层
    subgraph "🔄 LangGraph工作流控制层"
        direction LR
        
        subgraph "核心引擎"
            WorkflowEngine["工作流引擎<br/>StateGraph"]
            StateManager["状态管理器<br/>任务执行状态追踪"]
            PostgresCheckpointer["PostgreSQL检查点<br/>任务状态持久化"]
        end
        
        subgraph "工作流节点"
            GitMgmtNode["🔧 Git管理节点<br/>- 多仓库准备<br/>- 分支策略<br/>- 版本控制"]
            ServiceCodingNode["💻 微服务编码节点<br/>- 并行服务生成<br/>- API接口生成<br/>- 服务间调用"]
            TestNode["🧪 测试节点<br/>- 单元测试生成<br/>- 静态接口检查<br/>- API兼容性验证"]
            GitCommitNode["📤 Git提交节点<br/>- 代码提交<br/>- PR创建<br/>- 分支推送"]
        end
        
        subgraph "条件控制"
            TaskDepCheck["任务依赖检查<br/>前置任务完成验证<br/>循环依赖检测"]
            ServiceCheck["服务检查<br/>接口兼容性检查<br/>服务依赖验证"]
            TestCheck["测试检查<br/>单元测试通过率<br/>代码覆盖率验证"]
            QualityCheck["质量检查<br/>静态分析结果<br/>规范性验证"]
        end
    end
    
    %% 第三层：执行智能体层
    subgraph "🤖 执行智能体层"
        direction TB
        
        subgraph "🔧 Git管理智能体"
            GitManagerAgent["Git管理智能体<br/>🔧 多仓库协调器"]
            MultiRepoManager["多仓库管理器<br/>- 服务仓库创建<br/>- 分支策略统一<br/>- 版本依赖管理"]
            ServiceVersionController["服务版本控制器<br/>- 语义版本管理<br/>- 向后兼容检查<br/>- 依赖版本锁定"]
        end
        
        subgraph "💻 微服务编码智能体"
            MicroserviceCodingAgent["微服务编码智能体<br/>🤖 分布式编码专家"]
            ServiceArchAnalyzer["服务架构分析器<br/>- Spring Cloud架构<br/>- 分布式模式识别<br/>- 技术栈选择"]
            ParallelServiceGenerator["并行服务生成器<br/>- 任务驱动生成<br/>- 统一代码风格<br/>- 配置模板应用"]
            APIGenerator["API生成器<br/>- RESTful API实现<br/>- 异步消息接口<br/>- 接口文档生成"]
            ServiceInterconnector["服务互联生成器<br/>- Feign客户端生成<br/>- 消息队列集成<br/>- 服务发现配置"]
        end
        
        subgraph "🧪 测试智能体"
            TestAgent["测试智能体<br/>🧪 单元测试专家"]
            UnitTestGenerator["单元测试生成器<br/>- 任务导向测试<br/>- 边界条件测试<br/>- Mock对象生成"]
            StaticInterfaceChecker["静态接口检查器<br/>- 服务间接口匹配<br/>- API兼容性检查<br/>- 契约一致性验证"]
            CoverageAnalyzer["覆盖率分析器<br/>- 任务覆盖率统计<br/>- 测试质量评估<br/>- 覆盖率报告"]
        end
        
        subgraph "🔍 代码审查智能体"
            ReviewAgent["代码审查智能体<br/>🔍 质量把关者"]
            StaticAnalyzer["静态分析器<br/>- 语法检查<br/>- 代码质量评估<br/>- 复杂度分析"]
            SecurityChecker["安全检查器<br/>- 漏洞扫描<br/>- 安全规范检查<br/>- 依赖安全验证"]
            StandardChecker["规范检查器<br/>- 编码规范验证<br/>- 命名规范检查<br/>- 文档完整性"]
        end
        
        subgraph "📤 Git提交智能体"
            GitCommitAgent["Git提交智能体<br/>📤 版本管理专家"]
            CodeCommitter["代码提交器<br/>- 任务导向提交<br/>- 变更分析<br/>- 版本标签管理"]
            PushManager["推送管理器<br/>- 多仓库推送<br/>- 分支同步<br/>- 冲突处理"]
            PRCreator["PR创建器<br/>- 任务关联PR<br/>- 代码审查请求<br/>- 变更说明生成"]
        end
    end
    
    %% 左侧：工具支持层
    subgraph "🛠️ 工具支持层"
        direction TB
        
        subgraph "任务管理工具"
            TaskTools["任务管理工具<br/>- 任务优先级算法<br/>- 依赖图生成<br/>- 执行计划优化"]
        end
        
        subgraph "代码生成工具"
            CodeGenTools["代码生成工具<br/>- 模板引擎<br/>- 代码脚手架<br/>- 批量生成器"]
        end
        
        subgraph "API工具"
            APITools["API工具集<br/>- OpenAPI生成器<br/>- API文档生成<br/>- 接口兼容性检查"]
        end
        
        subgraph "测试工具"
            TestTools["单元测试工具<br/>- JUnit框架<br/>- Mock框架<br/>- 覆盖率工具"]
        end
        
        subgraph "Git工具"
            GitTools["Git操作工具<br/>- 多仓库操作<br/>- 分支管理<br/>- 合并工具"]
        end
    end
    
    %% 右侧：记忆与提示词层
    subgraph "🧠 知识与提示词层"
        direction TB
        
        subgraph "任务记忆"
            TaskMemory["任务拆分记忆<br/>- 拆分策略库<br/>- 依赖模式库<br/>- 优化经验"]
        end
        
        subgraph "执行记忆"
            ExecutionMemory["执行记忆<br/>- 服务模板库<br/>- 代码模式库<br/>- 测试策略库"]
        end
        
        subgraph "提示词库"
            TaskSplitPrompts["任务拆分提示词<br/>- 需求分析<br/>- 设计解析<br/>- 任务规划"]
            ExecutionPrompts["执行提示词<br/>- 编码生成<br/>- 测试设计<br/>- 质量检查"]
        end
    end
    
    %% 底部：MCP工具层
    subgraph "🔧 MCP工具层"
        direction LR
        MCPManager["MCP管理器"]
        SpringCloudMCP["Spring Cloud MCP"]
        MavenMCP["Maven MCP"]
        GitMCP["Git MCP"]
        OpenAPIMCP["OpenAPI MCP"]
        JUnitMCP["JUnit MCP"]
        SonarMCP["SonarQube MCP"]
        JpaMCP["JPA MCP"]
    end
    
    %% =============================================
    %% 主要数据流和调用关系
    %% =============================================
    
    %% 输入到任务拆分
    ReqDoc --> TaskSplitAgent
    DesignDoc --> TaskSplitAgent
    
    %% 任务拆分内部流程
    TaskSplitAgent --> RequirementAnalyzer
    RequirementAnalyzer --> DesignAnalyzer
    DesignAnalyzer --> TaskScheduler
    TaskScheduler --> TaskPriority
    TaskPriority --> TaskQueue
    TaskQueue --> ServiceTaskMap
    
    %% 任务拆分输出到工作流
    ServiceTaskMap --> WorkflowEngine
    TaskQueue --> StateManager
    
    %% 工作流控制
    WorkflowEngine --> StateManager
    StateManager <--> PostgresCheckpointer
    WorkflowEngine --> GitMgmtNode
    
    %% 工作流序列（基于任务队列）
    GitMgmtNode --> ServiceCodingNode
    ServiceCodingNode --> TaskDepCheck
    TaskDepCheck -->|任务依赖满足| TestNode
    TaskDepCheck -->|依赖未满足| ServiceCodingNode
    TestNode --> ServiceCheck
    ServiceCheck -->|服务检查通过| TestCheck
    ServiceCheck -->|服务检查失败| ServiceCodingNode
    TestCheck -->|测试通过| QualityCheck
    TestCheck -->|测试失败| ServiceCodingNode
    QualityCheck -->|质量通过| GitCommitNode
    QualityCheck -->|质量不过| ServiceCodingNode
    
    %% 节点调用智能体
    GitMgmtNode --> GitManagerAgent
    ServiceCodingNode --> MicroserviceCodingAgent
    TestNode --> TestAgent
    TestNode --> ReviewAgent
    GitCommitNode --> GitCommitAgent
    
    %% 任务拆分智能体调用工具和记忆
    TaskSplitAgent --> TaskTools
    TaskSplitAgent <--> TaskMemory
    TaskSplitAgent <--> TaskSplitPrompts
    
    %% 执行智能体调用工具和记忆
    MicroserviceCodingAgent --> CodeGenTools
    MicroserviceCodingAgent --> APITools
    TestAgent --> TestTools
    GitCommitAgent --> GitTools
    
    MicroserviceCodingAgent <--> ExecutionMemory
    TestAgent <--> ExecutionMemory
    GitCommitAgent <--> ExecutionPrompts
    
    %% MCP工具调用
    TaskSplitAgent --> MCPManager
    MicroserviceCodingAgent --> MCPManager
    TestAgent --> MCPManager
    GitManagerAgent --> MCPManager
    
    MCPManager --> SpringCloudMCP
    MCPManager --> MavenMCP
    MCPManager --> GitMCP
    MCPManager --> OpenAPIMCP
    MCPManager --> JUnitMCP
    MCPManager --> SonarMCP
    MCPManager --> JpaMCP
    
    %% 样式定义
    classDef inputClass fill:#fff2cc,stroke:#d6b656,stroke-width:3px,font-weight:bold
    classDef taskClass fill:#e1f5fe,stroke:#0277bd,stroke-width:3px,font-weight:bold
    classDef workflowClass fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px,font-weight:bold
    classDef agentClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,font-weight:bold
    classDef toolClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef mcpClass fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef memoryClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef nodeClass fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef conditionClass fill:#ffebee,stroke:#c62828,stroke-width:2px
    
    class ReqDoc,DesignDoc inputClass
    class TaskSplitAgent,RequirementAnalyzer,DesignAnalyzer,TaskScheduler,TaskQueue,TaskPriority,ServiceTaskMap taskClass
    class WorkflowEngine,StateManager,PostgresCheckpointer workflowClass
    class GitMgmtNode,ServiceCodingNode,TestNode,GitCommitNode nodeClass
    class TaskDepCheck,ServiceCheck,TestCheck,QualityCheck conditionClass
    class GitManagerAgent,MicroserviceCodingAgent,TestAgent,ReviewAgent,GitCommitAgent agentClass
    class TaskTools,CodeGenTools,APITools,TestTools,GitTools toolClass
    class MCPManager,SpringCloudMCP,MavenMCP,GitMCP,OpenAPIMCP,JUnitMCP,SonarMCP,JpaMCP mcpClass
    class TaskMemory,ExecutionMemory,TaskSplitPrompts,ExecutionPrompts memoryClass