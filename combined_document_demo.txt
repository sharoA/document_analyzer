设计文档 - 一局对接链数优化V0.1
1. 系统架构设计
1.1 项目介绍
一局对接链数的项目上线后，核心企业反馈，希望就已推送至平台的数据，在核心企业内部系统内修改部分信息（如额度信息）后，使用原业务编号再次推送至平台。就目前的接口校验逻辑，相同业务编号的业务数据不可重复推送。因而，需要结合核心企业需求，对接口的校验逻辑进行调整。
建设目标及路线。调整接口校验逻辑，兼容核心企业重推数据的场景。
1.2 功能需求说明
1.2.1 链数额度功能调整
调整说明:本期，对原"链数额度"功能做如下调整：
- 功能名称由"链数额度"变更为"额度管理"；
- 页面右上方新增"组织单元额度"按钮，当且仅当当前登录企业为多组织企业时展示该按钮。用户点击"组织单元额度"按钮，则跳转至"组织单元额度"列表页。
- 列表新增字段"额度类型"，置于"额度名称"之后，若为链数额度则取值为"链数额度"。
1.2.2 新增组织单元额度功能
调整说明:本期在核心企业侧链数额度功能下，新增"组织单元额度"列表页。支持用户查询当前登录企业下的具体组织单元的链数额度、云信额度明细。
a.筛选字段：
序号	字段名	类型格式	长度	默认值	必填	规则
1	组织单元名称	文本输入框	-	-	-	模糊搜索
2	额度名称	文本输入框	-	-	-	模糊搜索
3	额度类型	下拉列表	-	链数额度	-	下拉选项：链数额度、云信额度、全部
b.汇总字段：
序号	字段名	类型格式	规则
1	总额度（元）	数值	满足筛选条件的列表数据的“已分配额度（元）”之和
2	已用额度（元）	数值	满足筛选条件的列表数据的“已用额度（元）”之和
3	可用额度（元）	数值	满足筛选条件的列表数据的“可用额度（元）”之和
备注：筛选条件更新后，汇总值需要同步更新计算。
c.列表字段：
序号	字段名	类型格式	规则
1	组织单元名称	字符串	无
2	额度名称	字符串	无
3	额度类型	字符串	无
4	已分配额度（元）	数值	无
5	已用额度（元）	数值	无
6	可用额度（元）	数值	无
备注：列表默认按照组织单元名称为主要关键字、额度类型为次要关键字降序排列。

1.3 总体架构
采用微服务架构模式，实现松耦合、高可扩展的系统设计：
- 涉及2个后端服务：
1. 用户服务：zqyl-user-center-service
2. 确权开立服务：crcl-open

- 涉及2个数据库：
1. 用户数据库：MySQL 
2. 缓存：Redis

1.4 技术栈选型
- 后端框架：Spring Boot 2.7.x + Spring Cloud 2021.x
- 数据访问：MyBatis Plus 3.5.x
- 数据库：MySQL 8.0
- 缓存：Redis 6.0
- 消息队列：RabbitMQ 3.8
- 服务发现：Nacos
- 配置中心：Nacos
- 后端分页：pageHelper
- 部署：将代码提交到git分支即可

2. 服务设计

2.1 用户服务 (zqyl-user-center-service)
职责：用户管理、权限控制、角色管理

2.1.1 核心模块：
- 组织单元管理

2.1.2 API设计：
2.1.2.1 新增接口：
uri : GET /general/multiorgManage/queryCompanyUnitList    
method: GET
description:查询企业组织单元列表
入参示例：
{
  "unitCode": "sdf1",  #组织单元编号
  "openStatus": 1 ,    #组织单元状态 1：正常；0：禁用 默认全部
  "unitList" :[1,2,234]  #组织单元id 必传 
}

返参示例：
{
  "data": [
    {
      "unitId" : 234234 ,     #组织单元id 必传 
      "unitTypeDicType" : 1 , #组织单元类型 1：开立，2：支付
      "unitTypeId" : 12   ,   #组织单元类型表id 
      "openStatus" : 1   ,    #组织单元状态  1：正常；0：禁用 默认全部
      "unitCode" : "sdfsdfsd",#组织编号
      "unitName" : "测试单元" #组织单元名称
    }
  ]
}

2.1.3 数据库表设计：
CREATE TABLE t_cust_multiorg_unit(
  id bigint(20) NOT NULL COMMENT '主键id',
  company_id bigint(20) NOT NULL COMMENT '企业id',
  mutilorg_id bigint(10) NOT NULL COMMENT '多组织id',
  unit_code varchar(50) NOT NULL COMMENT '组织单元编号',
  unit_name varchar(255) NOT NULL COMMENT '组织单元名称',
  remark varchar(500) DEFAULT NULL COMMENT '备注',
  platform_type tinyint(2) NOT NULL COMMENT '平台类型(1云信2云租3云保)',
  status tinyint(2) NOT NULL COMMENT '状态1正常0删除',
  create_id bigint(20) NOT NULL COMMENT '创建人id',
  oper_user_name varchar(255) DEFAULT NULL COMMENT '创建人用户名',
  create_time datetime NOT NULL COMMENT '创建时间',
  modify_id bigint(20) DEFAULT NULL COMMENT '修改人id',
  modify_user_name varchar(255) DEFAULT NULL COMMENT '最后修改用户名',
  modify_time datetime DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY(id),
  KEY pk_company_id(company_id) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='多组织单元表';

2.2 确权开立服务 (crcl-open)
职责：确权开立、额度管理

2.2.1 核心模块：
- 确权开立模块
- 额度管理模块

2.2.2 API设计：
2.2.2.1 新增接口：
uri :  /crcl-open-api/lsLimit/listUnitLimitByCompanyId    
method: GET
description:组织单元额度列表

入参示例：
{
  "gwCompanyId" : 1,   #当前登录企业id  ,必传
  "unitName" : "abs",  #组织单元名称（模糊搜索）
  "limitSource" : "",  #额度名称（模糊搜索）
  "bizType" : 1,       #10：云信额度，80：链数额度（默认）
  "page" : 1,          #页码，必传
  "pageRow" : 10       #每页记录数，必传 
}

返参示例：
{
  "totalLimitAmt": 100 ,       #总额度
  "usedLimitAmt" :1 ,          #已用额度
  "usableLimitAmt" : 10,       #可用额度
  "unitLimitListDetail" : [{   #额度信息
    "unitName":"sdfs",         #组织单元名称
    "limitSource" : "232f",    #额度名称
    "bizType":1,               #额度类型：10：云信额度 80：链数额度
    "usedLimitAmt" : 1,        #已分配额度
    "usableLimitAmt" : 1,      #已用额度
    "totalLimitAmt" :1         #可用额度
  }]
}

特殊要求：
1、采用pagehelper进行分页
2、需要调用zqyl-user-center-service服务的/queryCompanyUnitList接口获取组织单元详细信息

2.2.2.2 新增接口：
uri : /crcl-open-api/lsLimit/listUnitLimitByCompanyIdExport   
method: GET
description: 组织单元额度列表导出


入参示例：
{
  "gwCompanyId" : 1,   #当前登录企业id  ,必传
  "unitName" : "abs",  #组织单元名称（模糊搜索）
  "limitSource" : "",  #额度名称（模糊搜索）
  "bizType" : 1,       #10：云信额度，80：链数额度（默认）
  "page" : 1,          #页码，必传
  "pageRow" : 10       #每页记录数，必传 
}

返参示例：
{
  "flag" : 1,    #0文件生成失败，1文件生成成功
  "msg": "",     #flag=0 提示内容
  "data" :" "    #flag=1 文件下载地址 
}

特殊要求：
1、文件生成在本地目录，采用本地链接形式返回路径。
2、文件类型为Excel列表，文件类型：xlsx
3、列表头列内容：组织单元名称、额度名称、额度类型、已分配额度（元）、已用额度（元）、可用额度（元）
4、需要调用zqyl-user-center-service服务的/queryCompanyUnitList接口获取组织单元详细信息

3 执行要求
3.1 涉及服务范围
本次没有新增服务，服务范围为：
1. 用户服务：zqyl-user-center-service，git地址：http://localhost:30000/ls/zqyl-user-center-service.git
2. 确权开立服务：crcl-open，git地址：http://localhost:30000/ls/crcl-open.git

3.2 涉及数据库范围
本次没有新增数据库，数据库范围为：
3.2.1 用户数据库：MySQL 
数据库配置
  url: jdbc:mysql://localhost:6446/dbwebappdb?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&characterEncoding=utf8&useUnicode=true
    username: dbwebapp
    password: dbwebapp
    driver-class-name: com.mysql.cj.jdbc.Driver


3.2.2 缓存：
redis:
  host: localhost
  port: 6379
  db: 0
  password: ''

3.3 涉及接口范围
本次新增接口，已经按服务范围进行划分，详见设计文档2服务设计部分。