<template>
  <div class="chat-container">
    <!-- 左侧边栏 -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2 class="app-title">
          <el-icon><ChatDotRound /></el-icon>
          analyDesign
        </h2>
        <el-button 
          type="primary" 
          @click="startNewChat"
          class="new-chat-btn"
        >
          新任务
        </el-button>
      </div>
      
      <div class="chat-history">
        <div class="history-section">
          <h3>需求文档智能分析</h3>
          <p class="section-subtitle">文档解析专家</p>
        </div>
        
        <div class="task-description">
          <h4>智能对话助手</h4>
          <p>专业的需求分析、访谈提纲生成和问卷设计助手</p>
          
          <div class="feature-tips">
            <p>💡 可以上传文档进行基于文档内容的智能对话</p>
            <p>📎 支持 Word、PDF、TXT、Markdown 格式文档</p>
          </div>
        </div>
      </div>

      <!-- 聊天消息区域 -->
      <div class="chat-messages" ref="messagesContainer">
        <div 
          v-for="message in messages" 
          :key="message.message_id"
          :class="['message', message.type]"
        >
          <div v-if="message.type === 'user'" class="user-message">
            <div class="message-content">{{ message.message }}</div>
            <div class="message-time">{{ formatTime(message.timestamp) }}</div>
          </div>
          
          <div v-else-if="message.type === 'chat_response'" class="bot-message">
            <div class="bot-avatar">
              <el-icon><User /></el-icon>
            </div>
            <div class="message-content">
              <div class="message-text" v-html="formatMessage(message.message)"></div>
              <div class="message-time">{{ formatTime(message.timestamp) }}</div>
            </div>
          </div>
        </div>
        
        <div v-if="isTyping" class="typing-indicator">
          <div class="bot-avatar">
            <el-icon><User /></el-icon>
          </div>
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>

      <!-- 输入区域 -->
      <div class="chat-input">
        <div class="input-container">
          <!-- 隐藏的文件上传组件 -->
          <el-upload
            ref="uploadRef"
            :auto-upload="false"
            :on-change="handleFileChange"
            :show-file-list="false"
            accept=".doc,.docx,.pdf,.txt,.md"
            style="display: none;"
          />
          
          <!-- 显示已上传的文件 -->
          <div v-if="uploadedFile" class="uploaded-file-card">
            <div class="file-card-header">
              <el-icon class="file-icon"><Document /></el-icon>
              <span class="file-name">{{ uploadedFile.name }}</span>
              <el-button 
                type="text" 
                size="small" 
                @click="removeFile"
                class="close-btn"
              >
                <el-icon><Close /></el-icon>
              </el-button>
            </div>
            <div class="file-card-footer">
              <span class="file-size">{{ formatFileSize(uploadedFile.size) }}</span>
              <el-button 
                type="primary" 
                size="small" 
                @click="analyzeDocument"
                :loading="isAnalyzing"
                class="analyze-btn"
              >
                <el-icon><Promotion /></el-icon>
                开始文档解析
              </el-button>
            </div>
          </div>
          
          <el-input
            v-model="currentMessage"
            type="textarea"
            :rows="3"
            placeholder="输入您的问题或需求..."
            @keydown.ctrl.enter="sendMessage"
            :disabled="isTyping"
            resize="none"
          />
                      <div class="input-actions">
            <el-button-group>
              <el-button size="small" @click="attachFile">
                <el-icon><Paperclip /></el-icon>
                附件
              </el-button>
              <el-button size="small" @click="expandInput">
                <el-icon><FullScreen /></el-icon>
                展开
              </el-button>
            </el-button-group>
            <el-button 
              type="primary" 
              @click="sendMessage"
              :disabled="!currentMessage.trim() || isTyping"
              :loading="isTyping"
            >
              发送
            </el-button>
          </div>
        </div>
      </div>
    </div>

    <!-- 右侧 Agent 工作空间 -->
    <div class="agent-workspace">
      <!-- 工作空间头部 -->
      <div class="workspace-header">
        <h3>Agent 的工作空间</h3>
        <!-- <div class="connection-status">
          <el-tag 
            :type="connectionStatusType" 
            size="small"
            effect="plain"
          >
            <el-icon><Connection /></el-icon>
            {{ connectionStatusText }}
          </el-tag>
        </div> -->
      </div>

      <!-- Tab 导航 -->
      <el-tabs v-model="activeTab" class="workspace-tabs">
        <!-- 实时处理状态 -->
        <el-tab-pane label="实时跟随" name="realtime">
          <div class="tab-content">
            <div class="status-header">
              <h4>处理状态</h4>
              <el-tag :type="processingStatus.type" size="small">
                {{ processingStatus.text }}
              </el-tag>
            </div>
            
            <div class="processing-steps">
              <el-timeline>
                <el-timeline-item
                  v-for="step in processingSteps"
                  :key="step.id"
                  :type="step.status"
                  :timestamp="step.timestamp"
                >
                  <div class="step-content">
                    <h5>{{ step.title }}</h5>
                    <p>{{ step.description }}</p>
                    <div v-if="step.progress !== undefined" class="step-progress">
                      <el-progress 
                        :percentage="step.status === 'success' ? 100 : step.progress" 
                        :status="step.status === 'success' ? 'success' : undefined"
                      />
                    </div>
                  </div>
                </el-timeline-item>
              </el-timeline>
            </div>
            
            <div v-if="currentProcessing" class="current-processing">
              <el-card>
                <template #header>
                  <div class="card-header">
                    <span>当前处理</span>
                    <el-icon class="rotating"><Loading /></el-icon>
                  </div>
                </template>
                <p>{{ currentProcessing }}</p>
              </el-card>
            </div>
          </div>
        </el-tab-pane>

        <!-- 上传文档预览 -->
        <el-tab-pane label="上传文档预览" name="preview">
          <div class="tab-content">
            <div v-if="!uploadedFile" class="empty-state">
              <el-empty description="暂无上传文档">
                <el-button type="primary" @click="attachFile">
                  <el-icon><Paperclip /></el-icon>
                  上传文档
                </el-button>
              </el-empty>
            </div>
            
            <div v-else class="document-preview">
              <div class="preview-header">
                <h4>{{ getPreviewTitle(uploadedFile) }}</h4>
                <div class="file-info">
                  <el-tag size="small" type="success">
                    <el-icon><Document /></el-icon>
                    {{ uploadedFile.name }}
                  </el-tag>
                  <span class="file-size">{{ formatFileSize(uploadedFile.size) }}</span>
                </div>
              </div>
              
              <div class="preview-content">
                <!-- 文档基本信息 -->
                <el-card style="margin-bottom: 16px;">
                  <template #header>
                    <div style="display: flex; align-items: center;">
                      <el-icon style="margin-right: 8px;"><Document /></el-icon>
                      <span>文档信息</span>
                    </div>
                  </template>
                  <el-descriptions :column="2" border size="small">
                    <el-descriptions-item label="文件名">
                      {{ uploadedFile.name }}
                    </el-descriptions-item>
                    <el-descriptions-item label="文件大小">
                      {{ formatFileSize(uploadedFile.size) }}
                    </el-descriptions-item>
                    <el-descriptions-item label="文件类型">
                      {{ getFileType(uploadedFile) }}
                    </el-descriptions-item>
                    <el-descriptions-item label="扩展名">
                      {{ getFileExtension(uploadedFile.name) }}
                    </el-descriptions-item>
                  </el-descriptions>
                </el-card>
                
                <!-- 文档预览区域 -->
                <el-card>
                  <template #header>
                    <div style="display: flex; align-items: center;">
                      <el-icon style="margin-right: 8px;"><View /></el-icon>
                      <span>文档预览</span>
                    </div>
                  </template>
                  
                  <!-- 使用DocumentPreview组件 -->
                  <DocumentPreview :file="uploadedFile" />
                </el-card>
                
                <!-- 操作按钮 -->
                <div style="margin-top: 24px; text-align: center; padding: 20px; border-top: 1px solid #e4e7ed;">
                  <el-button size="large" @click="analyzeDocument" :loading="isAnalyzing">
                    <el-icon><Promotion /></el-icon>
                    开始分析文档
                  </el-button>
                  <el-button size="large" @click="removeFile">
                    <el-icon><Close /></el-icon>
                    移除文档
                  </el-button>
                </div>
              </div>
            </div>
          </div>
        </el-tab-pane>

        <!-- 文件解析结果 -->
                    <el-tab-pane label="解析结果" name="files" data-tab="results">
          <div class="tab-content">
            <div v-if="!analysisResult" class="empty-state">
              <el-empty description="暂无解析结果">
                <el-button v-if="!uploadedFile" type="primary" @click="activeTab = 'preview'">
                  上传文档开始分析
                </el-button>
                <el-button v-else type="primary" size="large" @click="analyzeDocument" :loading="isAnalyzing">
                  <el-icon><Promotion /></el-icon>
                  开始分析文档
                </el-button>
              </el-empty>
            </div>
            
            <div v-else class="analysis-result">
              <div class="result-header">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div>
                    <div class="result-title">
                      <h4>{{  getAnalysisFileName() || '📄 文档解析结果' }}</h4>
                    </div>
                    <div class="result-meta">
                      <el-tag size="small" :type="getResultTypeTag(analysisResult.type)">
                        {{ getResultTypeText(analysisResult.type) }}
                      </el-tag>
                      <span class="result-time">{{ formatTime(analysisResult.timestamp) }}</span>
                    </div>
                  </div>
                  <el-button v-if="uploadedFile" type="primary" size="small" @click="analyzeDocument" :loading="isAnalyzing">
                    <el-icon><Promotion /></el-icon>
                    重新分析
                  </el-button>
                </div>
              </div>
              
              <!-- 分析结果显示区域 -->
              <div class="results-container">
                <el-scrollbar height="100%" class="analysis-scrollbar">
                  <div class="result-content">
                  <!-- 文件基本信息 -->
                  <el-card class="info-card" v-if="analysisResult">
                    <template #header>
                      <h5>当前文件基本信息</h5>
                    </template>
                    <el-descriptions :column="2" border size="small">
                      <el-descriptions-item label="文件名称">
                        {{ getAnalysisFileName() }}
                      </el-descriptions-item>
                      <el-descriptions-item label="文件类型">
                        {{ getAnalysisFileType() }}
                        
                      </el-descriptions-item>
                      <el-descriptions-item label="子类型">
                        {{ analysisResult.fileFormat.subType || '未知' }}
                      </el-descriptions-item>
                      <el-descriptions-item label="文件大小">
                        {{ uploadedFile ? formatFileSize(uploadedFile.size) : formatFileSize(analysisResult.fileFormat.basicInfo?.fileSize || 0) }}
                      </el-descriptions-item>
                      <el-descriptions-item label="字符数">
                        {{ getAnalysisCharacterCount() }}
                      </el-descriptions-item>
                    </el-descriptions>
                  </el-card>


                  <!-- 文档结构摘要 -->
                  <el-card class="info-card" v-if="analysisResult && analysisResult.documentStructure?.contentSummary">
                    <template #header>
                      <h5>📋 文档结构摘要</h5>
                    </template>
                    <div class="document-summary">
                      <!-- 摘要 -->
                      <div class="summary-section" v-if="analysisResult.documentStructure.contentSummary.abstract">
                        <h6>文档摘要</h6>
                        <p class="abstract-text">{{ analysisResult.documentStructure.contentSummary.abstract }}</p>
                      </div>
                      
                      <!-- 功能统计 -->
                      <el-descriptions :column="2" border size="small" style="margin-bottom: 16px;">
                        <el-descriptions-item label="功能数量">
                          {{ analysisResult.documentStructure.contentSummary.functionCount || 0 }}
                        </el-descriptions-item>
                        <el-descriptions-item label="API数量">
                          {{ analysisResult.documentStructure.contentSummary.apiCount || 0 }}
                        </el-descriptions-item>
                        <el-descriptions-item label="数据库变更">
                          {{ analysisResult.documentStructure.contentSummary.dbChangeCount || 0 }}
                        </el-descriptions-item>
                        <el-descriptions-item label="消息队列">
                          {{ analysisResult.documentStructure.contentSummary.mqCount || 0 }}
                        </el-descriptions-item>
                        <el-descriptions-item label="定时器">
                          {{ analysisResult.documentStructure.contentSummary.timerCount || 0 }}
                        </el-descriptions-item>
                      </el-descriptions>

                      <!-- 功能列表 -->
                      <div class="function-list" v-if="analysisResult.documentStructure.contentSummary.functionName && analysisResult.documentStructure.contentSummary.functionName.length > 0">
                        <h6>功能列表</h6>
                        <el-tag v-for="(func, index) in analysisResult.documentStructure.contentSummary.functionName" 
                               :key="index" 
                               type="primary" 
                               size="small" 
                               style="margin: 2px 4px 2px 0;">
                          {{ func }}
                        </el-tag>
                      </div>

                      <!-- API列表 -->
                      <div class="api-list" v-if="analysisResult.documentStructure.contentSummary.apiName && analysisResult.documentStructure.contentSummary.apiName.length > 0">
                        <h6>API列表</h6>
                        <el-tag v-for="(api, index) in analysisResult.documentStructure.contentSummary.apiName" 
                               :key="index" 
                               type="success" 
                               size="small" 
                               style="margin: 2px 4px 2px 0;">
                          {{ api }}
                        </el-tag>
                      </div>
                    </div>
                  </el-card>

                  <!-- 关键词分析 -->
                  <el-card class="info-card" v-if="analysisResult && analysisResult.documentStructure?.contentKeyWord">
                    <template #header>
                      <h5>🔍 关键词分析</h5>
                    </template>
                    <div class="keyword-analysis">
                      <!-- 基础关键词 -->
                      <div class="keywords-section" v-if="analysisResult.documentStructure.contentKeyWord.keywords">
                        <h6>基础关键词</h6>
                        <el-tag v-for="(keyword, index) in analysisResult.documentStructure.contentKeyWord.keywords" 
                               :key="index" 
                               size="small" 
                               style="margin: 2px 4px 2px 0;">
                          {{ keyword }}
                        </el-tag>
                      </div>

                      <!-- 主要关键词详情 -->
                      <div class="primary-keywords" v-if="analysisResult.documentStructure.contentKeyWord.primaryKeywords">
                        <h6>主要关键词详情</h6>
                        <el-table :data="analysisResult.documentStructure.contentKeyWord.primaryKeywords" 
                                 size="small" 
                                 style="width: 100%">
                          <el-table-column prop="keyword" label="关键词" width="100"/>
                          <el-table-column prop="frequency" label="频次" width="60"/>
                          <el-table-column prop="importance" label="重要度" width="80">
                            <template #default="scope">
                              {{ (parseFloat(scope.row.importance) * 100).toFixed(0) }}%
                            </template>
                          </el-table-column>
                          <el-table-column prop="positions" label="出现位置" min-width="120">
                            <template #default="scope">
                              <el-tag v-for="(pos, index) in scope.row.positions" 
                                     :key="index" 
                                     size="mini" 
                                     type="info"
                                     style="margin: 1px;">
                                {{ pos }}
                              </el-tag>
                            </template>
                          </el-table-column>
                        </el-table>
                      </div>

                      <!-- 语义聚类 -->
                      <div class="semantic-clusters" v-if="analysisResult.documentStructure.contentKeyWord.semanticClusters">
                        <h6>语义聚类</h6>
                        <div v-for="(cluster, index) in analysisResult.documentStructure.contentKeyWord.semanticClusters" 
                             :key="index" 
                             class="cluster-item">
                          <div class="cluster-header">
                            <span class="cluster-name">{{ cluster.clusterName }}</span>
                            <el-tag size="mini" type="warning">
                              相关度: {{ (parseFloat(cluster.coherenceScore) * 100).toFixed(0) }}%
                            </el-tag>
                          </div>
                          <div class="cluster-keywords">
                            <el-tag v-for="(keyword, kidx) in cluster.keywords" 
                                   :key="kidx" 
                                   size="mini" 
                                   style="margin: 2px;">
                              {{ keyword }}
                            </el-tag>
                          </div>
                        </div>
                      </div>
                    </div>
                  </el-card>

                  <!-- 元数据信息 -->
                  <el-card class="info-card" v-if="analysisResult && analysisResult.documentStructure?.metadata">
                    <template #header>
                      <h5>👥 元数据信息</h5>
                    </template>
                    <el-descriptions :column="1" border size="small">
                      <el-descriptions-item label="用户角色" v-if="analysisResult.documentStructure.metadata.userRole">
                        <el-tag v-for="(role, index) in analysisResult.documentStructure.metadata.userRole" 
                               :key="index" 
                               type="primary" 
                               size="small" 
                               style="margin: 2px 4px 2px 0;">
                          {{ role }}
                        </el-tag>
                      </el-descriptions-item>
                      <el-descriptions-item label="目标受众" v-if="analysisResult.documentStructure.metadata.targetAudience">
                        <el-tag v-for="(audience, index) in analysisResult.documentStructure.metadata.targetAudience" 
                               :key="index" 
                               type="success" 
                               size="small" 
                               style="margin: 2px 4px 2px 0;">
                          {{ audience }}
                        </el-tag>
                      </el-descriptions-item>
                      <el-descriptions-item label="使用模型" v-if="analysisResult.notes">
                        <el-tag v-for="(audience, index) in analysisResult.notes" 
                               :key="index" 
                               type="primary" 
                               size="small" 
                               style="margin: 2px 4px 2px 0;">
                               {{ analysisResult.notes }}
                        </el-tag>
                      </el-descriptions-item>
                    </el-descriptions>
                  </el-card>

                
                  
                  <!-- 内容分析结果 -->
                  <el-card class="info-card" v-if="analysisResult.contentAnalysis">
                    <template #header>
                      <div class="content-analysis-header">
                        <h5>📊 智能内容分析结果</h5>
                        <el-tag size="small" type="success">
                          {{ analysisResult.contentAnalysis.metadata?.analysis_method || 'LLM+向量数据库分析' }}
                        </el-tag>
                      </div>
                    </template>
                    <div class="content-analysis-result">
                      
                      <!-- 分析元数据信息 -->
                      <div v-if="analysisResult.contentAnalysis.metadata" class="metadata-section">
                        <el-descriptions :column="2" border size="small" style="margin-bottom: 20px;">
                          <el-descriptions-item label="分析方法">
                            <el-tag type="primary" size="small">
                              {{ analysisResult.contentAnalysis.metadata.analysis_method }}
                            </el-tag>
                          </el-descriptions-item>
                          <el-descriptions-item label="分析耗时">
                            {{ (analysisResult.contentAnalysis.metadata.analysis_time || 0).toFixed(2) }} 秒
                          </el-descriptions-item>
                          <el-descriptions-item label="内容长度">
                            {{ (analysisResult.contentAnalysis.metadata.content_length || 0).toLocaleString() }} 字符
                          </el-descriptions-item>
                          <el-descriptions-item label="分析块数">
                            {{ analysisResult.contentAnalysis.metadata.chunks_count || 0 }} 个
                          </el-descriptions-item>
                        </el-descriptions>
                      </div>

                      <!-- 变更分析结果 -->
                      <div v-if="analysisResult.contentAnalysis.change_analysis" class="change-analysis-section">
                        <!-- <h6 class="section-title">🔄 变更分析结果</h6> -->
                        
                        <!-- 分析概览 -->
                        <!-- <div v-if="analysisResult.contentAnalysis.change_analysis.summary" class="analysis-summary-card">
                          <el-card class="summary-card">
                            <template #header>
                              <span class="summary-header">📈 分析概览</span>
                            </template>
                            <el-row :gutter="16">
                              <el-col :span="8">
                                <div class="summary-item">
                                  <div class="summary-number">{{ getTotalChangesCount() }}</div>
                                  <div class="summary-label">内容变更</div>
                                </div>
                              </el-col>
                              <el-col :span="8">
                                <div class="summary-item">
                                  <div class="summary-number">{{ analysisResult.contentAnalysis.change_analysis.summary.total_deletions || 0 }}</div>
                                  <div class="summary-label">删除项目</div>
                                </div>
                              </el-col>
                              <el-col :span="8">
                                <div class="summary-item">
                                  <div class="summary-number">
                                    {{ getTotalChangesCount() + (analysisResult.contentAnalysis.change_analysis.summary.total_deletions || 0) }}
                                  </div>
                                  <div class="summary-label">总变更数</div>
                                </div>
                              </el-col>
                            </el-row>
                          </el-card>
                        </div> -->

                        <!-- 详细变更分析 -->
                        <div v-if="analysisResult.contentAnalysis.change_analysis.change_analyses?.length" class="change-details-section">
                          <h6 class="subsection-title">📝 变更详情</h6>
                          <div class="change-items">
                            <el-card 
                              v-for="(change, index) in analysisResult.contentAnalysis.change_analysis.change_analyses" 
                              :key="index"
                              class="change-item-card"
                              shadow="hover"
                            >
                              <template #header>
                                <div class="change-item-header">
                                  <span class="change-index">#{{ index + 1 }}</span>
                                  <el-tag 
                                    :type="getChangeTypeColor(change.changeType)"
                                    size="small"
                                  >
                                    {{ change.changeType || '未知变更' }}
                                  </el-tag>
                                </div>
                              </template>
                              
                              <div class="change-content">
                                <div class="change-reason">
                                  <strong>变更原因：</strong>
                                  <div class="change-reason-content" v-html="renderMarkdown(change.changeReason || '暂无描述')"></div>
                                </div>
                                
                                <div v-if="change.changeItems?.length" class="change-items-list">
                                  <strong>变更点：</strong>
                                  <ul>
                                    <li v-for="(item, idx) in change.changeItems" :key="idx">
                                      {{ item }}
                                    </li>
                                  </ul>
                                </div>

                                <div v-if="change.changeDetails?.length" class="change-items-list">
                                  <strong>变更详情：</strong>
                                  <div class="change-details-content" v-html="renderMarkdown(change.changeDetails || '暂无')"></div>
                                </div>

                                <div v-if="change.version?.length" class="version-info">
                                  <strong>参考版本：</strong>
                                  <el-tag 
                                    v-for="(version, vIdx) in change.version" 
                                    :key="vIdx"
                                    size="small"
                                    type="info"
                                    style="margin-right: 4px;"
                                  >
                                    {{ version }}
                                  </el-tag>
                                </div>
                              </div>
                            </el-card>
                          </div>
                        </div>

                        <!-- 删除项分析 -->
                        <div v-if="analysisResult.contentAnalysis.change_analysis.deletion_analyses?.length" class="deletion-section">
                          <h6 class="subsection-title">🗑️ 删除项分析</h6>
                          <div class="deletion-items">
                            <el-card 
                              v-for="(deletion, index) in analysisResult.contentAnalysis.change_analysis.deletion_analyses" 
                              :key="index"
                              class="deletion-item-card"
                              shadow="hover"
                            >
                              <template #header>
                                <div class="deletion-item-header">
                                  <span class="deletion-index">#{{ index + 1 }}</span>
                                  <el-tag type="danger" size="small">删除</el-tag>
                                </div>
                              </template>
                              
                              <div class="deletion-content">
                                <div class="deleted-item">
                                  <strong>删除项：</strong>
                                  <span class="deleted-text">{{ deletion.deletedItem || '未知项目' }}</span>
                                </div>
                                
                                <div v-if="deletion.section" class="deletion-section-info">
                                  <strong>所属章节：</strong>
                                  <el-tag size="small" type="warning">{{ deletion.section }}</el-tag>
                                </div>
                                
                                <div v-if="deletion.analysisResult" class="deletion-analysis">
                                  <strong>分析结果：</strong>
                                  <div class="deletion-analysis-content" v-html="renderMarkdown(deletion.analysisResult)"></div>
                                </div>
                                
                                <div v-if="deletion.changeDetails" class="deletion-details">
                                  <strong>变更详情：</strong>
                                  <div class="deletion-details-content" v-html="renderMarkdown(deletion.changeDetails)"></div>
                                </div>
                              </div>
                            </el-card>
                          </div>
                        </div>

                        <!-- 空状态 -->
                        <div v-if="!analysisResult.contentAnalysis.change_analysis.change_analyses?.length && !analysisResult.contentAnalysis.change_analysis.deletion_analyses?.length" class="empty-changes">
                          <el-empty description="暂无检测到内容变更">
                            <template #image>
                              <el-icon size="64px" color="#e6a23c"><DocumentChecked /></el-icon>
                            </template>
                          </el-empty>
                        </div>
                      </div>
                    </div>
                  </el-card>
                  

                  
                  <!-- 分析总结 -->
                  <el-card class="info-card" v-if="analysisResult.analysisSummary">
                    <template #header>
                      <div class="summary-header">
                        <h5>📝 {{ getAnalysisFileName() }} - 分析总结</h5>
                        <el-button-group size="small">
                          <el-button @click="copySummary">
                            <el-icon><DocumentCopy /></el-icon>
                            复制总结
                          </el-button>
                        </el-button-group>
                      </div>
                    </template>
                    <div class="summary-content">
                      <div class="summary-text" v-html="formatSummary(analysisResult.analysisSummary)"></div>
                    </div>
                  </el-card>
                  
                  <!-- 文档内容预览 -->
                  <el-card class="content-card" v-if="analysisResult.content">
                    <template #header>
                      <div class="content-header">
                        <h5>文档内容</h5>
                        <el-button-group size="small">
                          <el-button @click="copyContent">
                            <el-icon><DocumentCopy /></el-icon>
                            复制内容
                          </el-button>
                          <el-button @click="downloadContent">
                            <el-icon><Download /></el-icon>
                            下载文本
                          </el-button>
                        </el-button-group>
                      </div>
                    </template>
                    
                    <div class="content-preview">
                      <el-scrollbar max-height="50vh" class="document-content-scrollbar">
                        <pre class="content-text">{{ analysisResult.content }}</pre>
                      </el-scrollbar>
                    </div>
                  </el-card>
                  
                  <!-- Word文档特有信息 -->
                  <el-card 
                    class="info-card" 
                    v-if="analysisResult.details?.type === 'word' && analysisResult.details.tables?.length"
                  >
                    <template #header>
                      <h5>表格内容</h5>
                    </template>
                    <div class="tables-content">
                      <div 
                        v-for="(table, index) in analysisResult.details.tables" 
                        :key="index"
                        class="table-item"
                      >
                        <h6>表格 {{ index + 1 }}</h6>
                        <el-table :data="formatTableData(table)" border size="small">
                          <el-table-column 
                            v-for="(col, colIndex) in getTableColumns(table)" 
                            :key="colIndex"
                            :prop="`col${colIndex}`"
                            :label="`列${colIndex + 1}`"
                            show-overflow-tooltip
                          />
                        </el-table>
                      </div>
                    </div>
                  </el-card>
                  
                  <!-- PDF文档特有信息 -->
                  <el-card 
                    class="info-card" 
                    v-if="analysisResult.details?.type === 'pdf' && analysisResult.details.pages?.length"
                  >
                    <template #header>
                      <h5>页面内容</h5>
                    </template>
                    <div class="pages-content">
                      <el-collapse>
                        <el-collapse-item 
                          v-for="page in analysisResult.details.pages" 
                          :key="page.page_number"
                          :title="`第 ${page.page_number} 页`"
                          :name="page.page_number"
                        >
                          <div class="page-content">
                            <div v-if="page.error" class="page-error">
                              <el-alert 
                                :title="`第${page.page_number}页解析失败`"
                                type="warning"
                                :description="page.error"
                                show-icon
                                :closable="false"
                              />
                            </div>
                            <pre v-else class="page-text">{{ page.text || '该页面无文本内容' }}</pre>
                          </div>
                        </el-collapse-item>
                      </el-collapse>
                    </div>
                  </el-card>
                  
                  </div>
                </el-scrollbar>
              </div>
            </div>
          </div>
        </el-tab-pane>

        <!-- 设计方案 -->
        <el-tab-pane label="设计方案" name="design">
          <div class="tab-content">
            <div v-if="!analysisResult || !analysisResult.markdownContent" class="empty-state">
              <el-empty description="暂无设计方案">
                <el-button v-if="!uploadedFile" type="primary" @click="activeTab = 'preview'">
                  上传文档开始分析
                </el-button>
                <el-button v-else type="primary" size="large" @click="analyzeDocument" :loading="isAnalyzing">
                  <el-icon><Promotion /></el-icon>
                  开始分析生成设计方案
                </el-button>
              </el-empty>
            </div>
            
            <div v-else class="design-plan-content">
              <!-- Markdown设计报告 -->
              <el-card class="info-card">
                <template #header>
                  <div class="markdown-header">
                    <h5>📋 {{ getAnalysisFileName() }} - 设计报告</h5>
                    <el-button-group size="small">
                      <el-button v-if="!isEditingMarkdown" @click="toggleEditMode" type="warning">
                        <el-icon><Edit /></el-icon>
                        编辑报告
                      </el-button>
                      <el-button v-if="isEditingMarkdown" @click="saveMarkdownContent" type="success" :loading="isSavingMarkdown">
                        <el-icon><Check /></el-icon>
                        保存修改
                      </el-button>
                      <el-button v-if="isEditingMarkdown" @click="cancelEditMode" type="info">
                        <el-icon><Close /></el-icon>
                        取消编辑
                      </el-button>
                      <el-button @click="copyMarkdownContent">
                        <el-icon><DocumentCopy /></el-icon>
                        复制报告
                      </el-button>
                      <el-button @click="downloadMarkdownContent">
                        <el-icon><Download /></el-icon>
                        下载Markdown
                      </el-button>
                      <el-button @click="generateCode" :loading="isGeneratingCode" type="success">
                        <el-icon><Edit /></el-icon>
                        生成代码
                      </el-button>
                    </el-button-group>
                  </div>
                </template>
                
                <!-- 编辑模式 -->
                <div v-if="isEditingMarkdown" class="markdown-editor-container">
                  <el-row :gutter="16" style="height: 70vh;">
                    <!-- 编辑器 -->
                    <el-col :span="12">
                      <div class="editor-panel">
                        <div class="editor-header">
                          <h6>📝 Markdown编辑器</h6>
                          <el-tooltip content="支持标准Markdown语法">
                            <el-icon><QuestionFilled /></el-icon>
                          </el-tooltip>
                        </div>
                        <el-input
                          v-model="editingMarkdownContent"
                          type="textarea"
                          :rows="25"
                          placeholder="请输入Markdown内容..."
                          resize="none"
                          class="markdown-editor"
                          @input="onMarkdownEdit"
                        />
                      </div>
                    </el-col>
                    
                    <!-- 预览 -->
                    <el-col :span="12">
                      <div class="preview-panel">
                        <div class="editor-header">
                          <h6>👁️ 实时预览</h6>
                          <el-tooltip content="编辑内容的实时预览">
                            <el-icon><View /></el-icon>
                          </el-tooltip>
                        </div>
                        <el-scrollbar max-height="calc(70vh - 50px)" class="preview-scrollbar">
                          <div class="markdown-preview-edit" v-html="renderMarkdown(editingMarkdownContent)"></div>
                        </el-scrollbar>
                      </div>
                    </el-col>
                  </el-row>
                  
                  <!-- 编辑工具栏 -->
                  <div class="editor-toolbar">
                    <el-button-group size="small">
                      <el-button @click="insertMarkdownSyntax('**', '**')" title="加粗">
                        <el-icon><Document /></el-icon>
                        粗体
                      </el-button>
                      <el-button @click="insertMarkdownSyntax('*', '*')" title="斜体">
                        <el-icon><Edit /></el-icon>
                        斜体
                      </el-button>
                      <el-button @click="insertMarkdownSyntax('## ', '')" title="标题">
                        <el-icon><Promotion /></el-icon>
                        标题
                      </el-button>
                      <el-button @click="insertMarkdownSyntax('- ', '')" title="列表">
                        <el-icon><List /></el-icon>
                        列表
                      </el-button>
                      <el-button @click="insertMarkdownSyntax('`', '`')" title="代码">
                        <el-icon><Edit /></el-icon>
                        代码
                      </el-button>
                    </el-button-group>
                    
                    <div class="editor-stats">
                      <span>字符数: {{ editingMarkdownContent.length }}</span>
                      <span>行数: {{ editingMarkdownContent.split('\n').length }}</span>
                    </div>
                  </div>
                </div>
                
                <!-- 查看模式 -->
                <div v-else class="markdown-content">
                  <el-scrollbar max-height="70vh" class="markdown-content-scrollbar">
                    <div class="markdown-preview" v-html="renderMarkdown(analysisResult.markdownContent)"></div>
                  </el-scrollbar>
                </div>
                
                <!-- 操作按钮 -->
                <div class="markdown-actions" style="margin-top: 16px; text-align: center; padding: 16px; border-top: 1px solid #e4e7ed;">
                  <el-button type="primary" @click="analyzeWithAI">
                    <el-icon><Promotion /></el-icon>
                    智能处理
                  </el-button>
                  <el-button @click="clearResult">
                    <el-icon><Delete /></el-icon>
                    清空结果
                  </el-button>
                </div>
              </el-card>
             
            </div>
          </div>
        </el-tab-pane>

        <!-- 终端 -->
        <!-- <el-tab-pane label="终端" name="export">
          <div class="tab-content">
            <div class="export-options">
              <h4>导出选项</h4>
              
              <el-card class="export-card">
                <template #header>
                  <div class="card-header">
                    <el-icon><Document /></el-icon>
                    <span>分析报告</span>
                  </div>
                </template>
                <p>导出完整的需求分析报告，包含所有分析结果和建议</p>
                <div class="export-actions">
                  <el-button-group>
                                    <el-button @click="exportReport('pdf')" :disabled="!analysisResult">
                  <el-icon><Download /></el-icon>
                  结构化PDF
                </el-button>
                <el-button @click="exportPageAsPDF" :disabled="!analysisResult" type="primary">
                  <el-icon><Download /></el-icon>
                  页面PDF
                </el-button>
                    <el-button @click="exportReport('word')" :disabled="!analysisResult">
                      <el-icon><Download /></el-icon>
                      Word
                    </el-button>
                    <el-button @click="exportReport('markdown')" :disabled="!analysisResult">
                      <el-icon><Download /></el-icon>
                      Markdown
                    </el-button>
                  </el-button-group>
                </div>
              </el-card>
              
              <el-card class="export-card">
                <template #header>
                  <div class="card-header">
                    <el-icon><ChatDotRound /></el-icon>
                    <span>对话记录</span>
                  </div>
                </template>
                <p>导出完整的对话记录和交互历史</p>
                <div class="export-actions">
                  <el-button @click="exportChat()" :disabled="messages.length === 0">
                    <el-icon><Download /></el-icon>
                    导出对话
                  </el-button>
                </div>
              </el-card>
              
              <el-card class="export-card">
                <template #header>
                  <div class="card-header">
                    <el-icon><Setting /></el-icon>
                    <span>自定义导出</span>
                  </div>
                </template>
                <p>选择特定内容进行导出</p>
                <div class="custom-export">
                  <el-checkbox-group v-model="exportOptions">
                    <el-checkbox label="basicInfo">基本信息</el-checkbox>
                    <el-checkbox label="clientInfo">需求方信息</el-checkbox>
                    <el-checkbox label="analysis">详细分析</el-checkbox>
                    <el-checkbox label="suggestions">建议和改进</el-checkbox>
                    <el-checkbox label="chat">对话记录</el-checkbox>
                  </el-checkbox-group>
                  <el-button 
                    type="primary" 
                    @click="exportCustom()" 
                    :disabled="exportOptions.length === 0"
                    style="margin-top: 10px;"
                  >
                    <el-icon><Download /></el-icon>
                    自定义导出
                  </el-button>
                </div>
              </el-card>
            </div>
          </div>
        </el-tab-pane> -->
      </el-tabs>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted, nextTick, watch } from 'vue'
import { useWebSocketStore } from '../stores/websocket'
import axios from 'axios'
import { 
  ChatDotRound, 
  User, 
  Connection, 
  Microphone, 
  Document, 
  Check,
  Loading, 
  Promotion,
  Close,
  Paperclip,
  FullScreen,
  Setting,
  Download,
  View,
  InfoFilled,
  ArrowLeft,
  ArrowRight,
  ZoomIn,
  ZoomOut,
  DocumentCopy,
  Delete,
  DocumentChecked,
  Edit
} from '@element-plus/icons-vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import DocumentPreview from './DocumentPreview.vue'
import MarkdownIt from 'markdown-it'
import { exportToPDF, exportAnalysisResultToPDF, exportPageScreenshotToPDF, exportSimplePageToPDF, exportDOMContentToPDF } from '../utils/pdfExport'

// 创建独立的axios实例作为备用
const apiClient = axios.create({
  baseURL: 'http://localhost:8082',
  timeout: 900000, // 15分钟超时，适应代码生成等长时间任务
  headers: {
    'Content-Type': 'application/json',
  }
})

// 响应式数据
const currentMessage = ref('')
const messagesContainer = ref(null)
const uploadRef = ref(null)
const uploadedFile = ref(null)
const isAnalyzing = ref(false)
const isTyping = ref(false)
const isSending = ref(false)
const showRightPanel = ref(false)
const activeTab = ref('realtime')
const exportOptions = ref([])

// Markdown编辑相关状态
const isEditingMarkdown = ref(false)
const editingMarkdownContent = ref('')
const originalMarkdownContent = ref('')
const isSavingMarkdown = ref(false)

// 代码生成相关状态
const isGeneratingCode = ref(false)

// WebSocket store
const wsStore = useWebSocketStore()

// 计算属性
const messages = computed(() => wsStore.messages)
const isConnected = computed(() => wsStore.isConnected)
const connectionStatus = computed(() => wsStore.connectionStatus)
const processingStatus = computed(() => ({
  type: wsStore.isProcessing ? 'warning' : 'success',
  text: wsStore.isProcessing ? '处理中...' : '就绪'
}))
const processingSteps = computed(() => wsStore.processingSteps || [])
const currentProcessing = computed(() => wsStore.currentProcessing)
const analysisResult = computed(() => wsStore.analysisResult)
// 监听 analysisResult 变化并打印
watch(analysisResult, (newValue) => {
  console.log('📊 Analysis Result:', newValue)
}, { deep: true })

const connectionStatusType = computed(() => {
  switch (connectionStatus.value) {
    case 'connected': return 'success'
    case 'connecting': return 'warning'
    case 'disconnected': return 'danger'
    default: return 'info'
  }
})

const connectionStatusText = computed(() => {
  switch (connectionStatus.value) {
    case 'connected': return '已连接'
    case 'connecting': return '连接中'
    case 'disconnected': return '已断开'
    default: return '未知状态'
  }
})

const parsingStatusType = computed(() => {
  switch (wsStore.parsingStatus) {
    case 'uploading': return 'warning'
    case 'parsing': return 'primary'
    case 'content_analyzing': return 'primary'
    case 'ai_analyzing': return 'primary'
    case 'completed': return 'success'
    case 'failed': return 'danger'
    default: return 'info'
  }
})

const parsingStatusText = computed(() => {
  switch (wsStore.parsingStatus) {
    case 'idle': return '待解析'
    case 'uploading': return '上传中'
    case 'parsing': return '文档解析中'
    case 'content_analyzing': return '内容分析中'
    case 'ai_analyzing': return '智能处理中'
    case 'completed': return '解析完成'
    case 'failed': return '解析失败'
    default: return '未知状态'
  }
})

// 方法
const scrollToBottom = () => {
  nextTick(() => {
    if (messagesContainer.value) {
      messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight
    }
  })
}

const formatTime = (timestamp) => {
  try {
    const date = new Date(timestamp)
    return date.toLocaleTimeString('zh-CN', { 
      hour: '2-digit', 
      minute: '2-digit' 
    })
  } catch (error) {
    return ''
  }
}

const formatFileSize = (bytes) => {
  if (bytes === 0) return '0 B'
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i]
}

const getFileType = (file) => {
  const typeMap = {
    'application/msword': 'Microsoft Word 文档',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Microsoft Word 文档',
    'application/pdf': 'PDF 文档',
    'text/plain': '纯文本文档',
    'text/markdown': 'Markdown 文档'
  }
  return typeMap[file.type] || '未知文档类型'
}

const getFileExtension = (fileName) => {
  const lastDot = fileName.lastIndexOf('.')
  return lastDot !== -1 ? fileName.substring(lastDot) : '无扩展名'
}

const getPreviewTitle = (file) => {
  return '文档预览'
}

const formatMessage = (message) => {
  return message
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code>$1</code>')
}

const sendMessage = async () => {
  if (!currentMessage.value.trim() || isTyping.value) return
  
  const message = currentMessage.value.trim()
  currentMessage.value = ''
  isTyping.value = true
  
  try {
    await wsStore.sendMessage(message)
  } catch (error) {
    ElMessage.error('发送消息失败: ' + error.message)
  } finally {
    isTyping.value = false
  }
}

const startNewChat = () => {
  wsStore.clearMessages()
  uploadedFile.value = null
  activeTab.value = 'realtime'
  ElMessage.success('已开始新任务')
}

const toggleRealtime = () => {
  ElMessage.info('实时问答功能开发中...')
}

const showFiles = () => {
  activeTab.value = 'files'
}

const attachFile = () => {
  // 触发隐藏的文件上传组件
  const fileInput = uploadRef.value?.$el.querySelector('input[type="file"]')
  if (fileInput) {
    fileInput.click()
  }
}

const expandInput = () => {
  ElMessageBox.prompt('请输入详细内容', '展开输入', {
    inputType: 'textarea',
    inputValue: currentMessage.value,
    inputPlaceholder: '请输入您的问题或需求...'
  }).then(({ value }) => {
    currentMessage.value = value
  }).catch(() => {
    // 用户取消
  })
}

// 文件上传相关方法
const handleFileChange = (file) => {
  console.log('文件上传开始:', file)
  
  const allowedTypes = [
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/pdf',
    'text/plain',
    'text/markdown'
  ]
  
  console.log('文件类型:', file.raw.type)
  console.log('文件名:', file.name)
  console.log('文件大小:', file.size)
  
  // 检查文件类型
  if (!allowedTypes.includes(file.raw.type) && !file.name.match(/\.(doc|docx|pdf|txt|md)$/i)) {
    ElMessage.error('不支持的文件格式，请上传 Word、PDF、TXT 或 Markdown 文件')
    return false
  }
  
  // 检查文件大小（21MB限制）
  const maxFileSize = 21 * 1024 * 1024 // 21MB
  if (file.raw.size > maxFileSize) {
    const fileSizeMB = (file.raw.size / (1024 * 1024)).toFixed(1)
    ElMessage.error(`文件大小 ${fileSizeMB}MB 超过限制，最大允许 21MB`)
    return false
  }
  
  // 存储原始的File对象，而不是Element Plus的包装对象
  uploadedFile.value = file.raw
  console.log('uploadedFile设置完成:', uploadedFile.value)
  
  // 使用nextTick确保DOM更新后再切换页签
  nextTick(() => {
    console.log('切换到预览页签...')
    activeTab.value = 'preview'
    console.log('当前活动页签:', activeTab.value)
    
    // 强制触发响应式更新
    setTimeout(() => {
      console.log('延迟检查 - 当前页签:', activeTab.value)
      console.log('延迟检查 - 上传文件:', uploadedFile.value?.name)
    }, 100)
  })
  
  const fileSizeMB = (file.raw.size / (1024 * 1024)).toFixed(1)
  ElMessage.success(`文件 ${file.name} (${fileSizeMB}MB) 已选择，点击"开始分析"进行处理`)
}

const removeFile = () => {
  uploadedFile.value = null
  uploadRef.value?.clearFiles()
}

const analyzeDocument = async () => {
  if (!uploadedFile.value) {
    ElMessage.warning('请先上传文档')
    return
  }
  
  isAnalyzing.value = true
  activeTab.value = 'realtime'
  
  try {
    // 清空之前的处理步骤
    wsStore.clearProcessingSteps()
    wsStore.resetParsingState()
    
    // 添加文档上传完成步骤
    wsStore.updateProcessingStep({
      id: 'step_upload',
      title: '文档上传',
      description: `文件上传完成: ${uploadedFile.value.name}`,
      status: 'success',
      timestamp: new Date().toLocaleTimeString(),
      progress: 100
    })
    
    // 使用V2版本的完整分析流程
    const result = await wsStore.startFullAnalysisV2(uploadedFile.value)
    
    if (result.success) {
      ElMessage.success('完整分析流程已启动，请查看实时进度')
      
      // 监听解析状态变化
      const checkStatus = () => {
        if (wsStore.parsingStatus === 'completed') {
          ElMessage.success('完整分析完成')
          activeTab.value = 'files'
          isAnalyzing.value = false
        } else if (wsStore.parsingStatus === 'failed') {
          ElMessage.error('分析失败')
          isAnalyzing.value = false
        } else if (wsStore.isFileProcessing) {
          // 继续监听
          setTimeout(checkStatus, 1000)
        } else {
          isAnalyzing.value = false
        }
      }
      
      checkStatus()
    } else {
      throw new Error(result.error || '启动分析失败')
    }
    
  } catch (error) {
    ElMessage.error('分析启动失败: ' + error.message)
    isAnalyzing.value = false
    
    // 添加失败步骤
    wsStore.updateProcessingStep({
      id: 'step_parsing_failed',
      title: '解析失败',
      description: `解析失败: ${error.message}`,
      status: 'danger',
      timestamp: new Date().toLocaleTimeString(),
      progress: 0
    })
  }
}

// 导出功能
const exportReport = async (format) => {
  if (!analysisResult.value) {
    ElMessage.warning('暂无分析结果可导出')
    return
  }
  
  try {
    if (format === 'pdf') {
      // PDF导出
      const fileName = getAnalysisFileName().replace(/\.[^/.]+$/, "") // 移除原文件扩展名
      const pdfFileName = `${fileName}_分析报告_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`
      
      // 显示进度提示
      let progressMessage = null
      
      const success = await exportAnalysisResultToPDF(analysisResult.value, pdfFileName, {
        onProgress: (message) => {
          if (progressMessage) progressMessage.close()
          progressMessage = ElMessage({
            message: message,
            type: 'info',
            duration: 0,
            showClose: false
          })
        },
        onSuccess: (message) => {
          if (progressMessage) progressMessage.close()
          ElMessage.success('PDF导出成功！')
        },
        onError: (error) => {
          if (progressMessage) progressMessage.close()
          console.error('PDF导出失败:', error)
          ElMessage.error('PDF导出失败: ' + error.message)
        }
      })
      
      if (progressMessage) progressMessage.close()
      
    } else {
      // 其他格式的导出（保持原有逻辑）
      ElMessage.success(`正在导出 ${format.toUpperCase()} 格式的分析报告...`)
      
      // 模拟导出过程
      setTimeout(() => {
        ElMessage.success('导出完成')
      }, 2000)
    }
  } catch (error) {
    ElMessage.error('导出失败: ' + error.message)
  }
}

const exportChat = async () => {
  if (messages.value.length === 0) {
    ElMessage.warning('暂无对话记录可导出')
    return
  }
  
  try {
    const chatContent = messages.value.map(msg => {
      const time = formatTime(msg.timestamp)
      const sender = msg.type === 'user' ? '用户' : 'AI助手'
      return `[${time}] ${sender}: ${msg.message}`
    }).join('\n')
    
    const blob = new Blob([chatContent], { type: 'text/plain;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `对话记录_${new Date().toLocaleDateString()}.txt`
    a.click()
    URL.revokeObjectURL(url)
    
    ElMessage.success('对话记录导出完成')
  } catch (error) {
    ElMessage.error('导出失败: ' + error.message)
  }
}

const exportCustom = async () => {
  if (exportOptions.value.length === 0) {
    ElMessage.warning('请选择要导出的内容')
    return
  }
  
  try {
    let content = '# 自定义导出报告\n\n'
    
    if (exportOptions.value.includes('basicInfo') && analysisResult.value?.basicInfo) {
      content += '## 基本信息\n'
      Object.entries(analysisResult.value.basicInfo).forEach(([key, value]) => {
        content += `- ${key}: ${value}\n`
      })
      content += '\n'
    }
    
    if (exportOptions.value.includes('clientInfo') && analysisResult.value?.clientInfo) {
      content += '## 需求方信息\n'
      Object.entries(analysisResult.value.clientInfo).forEach(([key, value]) => {
        content += `- ${key}: ${value}\n`
      })
      content += '\n'
    }
    
    if (exportOptions.value.includes('analysis') && analysisResult.value?.analysis) {
      content += '## 详细分析\n'
      content += analysisResult.value.analysis.replace(/<[^>]*>/g, '') + '\n\n'
    }
    
    if (exportOptions.value.includes('suggestions') && analysisResult.value?.suggestions) {
      content += '## 建议和改进\n'
      analysisResult.value.suggestions.forEach(suggestion => {
        content += `- ${suggestion}\n`
      })
      content += '\n'
    }
    
    if (exportOptions.value.includes('chat') && messages.value.length > 0) {
      content += '## 对话记录\n'
      messages.value.forEach(msg => {
        const time = formatTime(msg.timestamp)
        const sender = msg.type === 'user' ? '用户' : 'AI助手'
        content += `**[${time}] ${sender}**: ${msg.message}\n\n`
      })
    }
    
    const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `自定义报告_${new Date().toLocaleDateString()}.md`
    a.click()
    URL.revokeObjectURL(url)
    
    ElMessage.success('自定义导出完成')
  } catch (error) {
    ElMessage.error('导出失败: ' + error.message)
  }
}

// 导出当前页面为PDF
const exportPageAsPDF = async () => {
  if (!analysisResult.value) {
    ElMessage.warning('暂无分析结果可导出')
    return
  }
  
  // 确保当前在解析结果页签
  if (activeTab.value !== 'files') {
    ElMessage.warning('请先切换到"解析结果"页签')
    return
  }
  
  try {
    // 多种方式尝试找到解析结果的容器元素
    let resultsContainer = null
    
    // 优先查找有data-tab属性的元素
    resultsContainer = document.querySelector('[data-tab="results"]')
    
    // 如果找不到，尝试其他选择器
    if (!resultsContainer) {
      resultsContainer = document.querySelector('.el-tab-pane[name="files"]')
    }
    
    if (!resultsContainer) {
      resultsContainer = document.querySelector('div[name="files"]')
    }
    
    // 如果还是找不到，寻找包含解析结果内容的区域
    if (!resultsContainer) {
      const tabPanes = document.querySelectorAll('.el-tab-pane')
      for (let pane of tabPanes) {
        if (pane.style.display !== 'none' && (pane.querySelector('.tab-content') || pane.querySelector('.analysis-result'))) {
          resultsContainer = pane
          break
        }
      }
    }
    
    // 最后尝试查找当前激活的页签内容
    if (!resultsContainer) {
      const activePane = document.querySelector('.el-tab-pane:not([style*="display: none"])')
      if (activePane && activePane.querySelector('.analysis-result, .tab-content')) {
        resultsContainer = activePane
      }
    }
    
    if (!resultsContainer) {
      ElMessage.error('找不到解析结果页面，请确保您在"解析结果"页签中且有分析结果')
      console.log('可用的元素:', {
        'data-tab': document.querySelector('[data-tab="results"]'),
        'el-tab-pane[name="files"]': document.querySelector('.el-tab-pane[name="files"]'),
        'div[name="files"]': document.querySelector('div[name="files"]'),
        'activeTab': activeTab.value
      })
      return
    }
    
    console.log('找到解析结果容器:', resultsContainer)
    
    const fileName = getAnalysisFileName().replace(/\.[^/.]+$/, "")
    const pdfFileName = `${fileName}_页面截图_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`
    
    // 显示进度提示
    let progressMessage = null
    
    // 优先使用DOM内容导出（不依赖截图）
    let success = false
    try {
      success = await exportDOMContentToPDF(resultsContainer, pdfFileName, {
        onProgress: (message) => {
          if (progressMessage) progressMessage.close()
          progressMessage = ElMessage({
            message: message,
            type: 'info',
            duration: 0,
            showClose: false
          })
        },
        onSuccess: (message) => {
          if (progressMessage) progressMessage.close()
          ElMessage.success('页面PDF导出成功！')
        },
        onError: (error) => {
          if (progressMessage) progressMessage.close()
          console.error('DOM内容PDF导出失败:', error)
          throw error // 抛出错误以便尝试其他版本
        }
      })
    } catch (domError) {
      console.log('DOM内容导出失败，尝试简化版本...', domError)
      
      try {
        // 如果DOM导出失败，尝试简化版本
        success = await exportSimplePageToPDF(resultsContainer, pdfFileName, {
          onProgress: (message) => {
            if (progressMessage) progressMessage.close()
            progressMessage = ElMessage({
              message: message,
              type: 'info',
              duration: 0,
              showClose: false
            })
          },
          onSuccess: (message) => {
            if (progressMessage) progressMessage.close()
            ElMessage.success('页面PDF导出成功！')
          },
          onError: (error) => {
            if (progressMessage) progressMessage.close()
            console.error('简化PDF导出失败:', error)
            throw error
          }
        })
      } catch (simpleError) {
        console.log('简化版导出失败，尝试高级版本...', simpleError)
        
        // 最后尝试高级版本
        success = await exportPageScreenshotToPDF(resultsContainer, pdfFileName, {
          onProgress: (message) => {
            if (progressMessage) progressMessage.close()
            progressMessage = ElMessage({
              message: message,
              type: 'info',
              duration: 0,
              showClose: false
            })
          },
          onSuccess: (message) => {
            if (progressMessage) progressMessage.close()
            ElMessage.success('页面PDF导出成功！')
          },
          onError: (error) => {
            if (progressMessage) progressMessage.close()
            console.error('页面PDF导出失败:', error)
            ElMessage.error('页面PDF导出失败: ' + error.message)
          }
        })
      }
    }
    
    if (progressMessage) progressMessage.close()
    
  } catch (error) {
    console.error('导出过程异常:', error)
    ElMessage.error('页面PDF导出失败: ' + error.message)
  }
}

// 监听消息变化，自动滚动到底部
watch(messages, () => {
  scrollToBottom()
}, { deep: true })

// 监听上传文件变化
watch(uploadedFile, (newFile, oldFile) => {
  console.log('uploadedFile变化:', { newFile, oldFile })
}, { deep: true })

// 监听活动页签变化
watch(activeTab, (newTab, oldTab) => {
  console.log('activeTab变化:', { newTab, oldTab })
})

// 组件挂载时初始化
onMounted(() => {
  scrollToBottom()
  console.log('组件已挂载')
  console.log('初始uploadedFile:', uploadedFile.value)
  console.log('初始activeTab:', activeTab.value)
  
  // 监听切换到结果页签的事件
  window.addEventListener('switchToResultsTab', handleSwitchToResultsTab)
  
  // 设置全局图片预览函数
  window.previewDocumentImage = previewDocumentImage
  window.closeImagePreview = closeImagePreview
  window.downloadImage = downloadImage
  window.copyImageUrl = copyImageUrl
})

// 事件处理函数
const handleSwitchToResultsTab = (event) => {
  const { tab } = event.detail
  if (tab) {
    activeTab.value = tab
    ElMessage.success('分析完成，已自动切换到解析结果页签')
  }
}

// 组件卸载时清理事件监听器
onUnmounted(() => {
  window.removeEventListener('switchToResultsTab', handleSwitchToResultsTab)
  
  // 清理全局图片预览函数
  delete window.previewDocumentImage
  delete window.closeImagePreview
  delete window.downloadImage
  delete window.copyImageUrl
})

const getResultTypeTag = (type) => {
  switch (type) {
    case 'text': return 'primary'
    case 'word': return 'success'
    case 'pdf': return 'warning'
    default: return 'info'
  }
}

const getResultTypeText = (type) => {
  switch (type) {
    case 'text': return '文本文档'
    case 'word': return 'Word文档'
    case 'pdf': return 'PDF文档'
    default: return '文档解析'
  }
}

// 表格数据格式化
const formatTableData = (table) => {
  if (!table || !Array.isArray(table)) return []
  
  return table.map(row => {
    const rowData = {}
    row.forEach((cell, index) => {
      rowData[`col${index}`] = cell
    })
    return rowData
  })
}

const getTableColumns = (table) => {
  if (!table || !Array.isArray(table) || table.length === 0) return []
  return table[0] || []
}

// 内容操作方法
const copyContent = async () => {
  if (!analysisResult.value?.content) {
    ElMessage.warning('没有可复制的内容')
    return
  }
  
  try {
    await navigator.clipboard.writeText(analysisResult.value.content)
    ElMessage.success('内容已复制到剪贴板')
  } catch (error) {
    ElMessage.error('复制失败')
  }
}

const downloadContent = () => {
  if (!analysisResult.value?.content) {
    ElMessage.warning('没有可下载的内容')
    return
  }
  
  const fileName = getAnalysisFileName().replace(/\.[^/.]+$/, "") // 移除原文件扩展名
  const blob = new Blob([analysisResult.value.content], { type: 'text/plain;charset=utf-8' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `${fileName}_content.txt`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
  ElMessage.success('内容下载开始')
}

const analyzeWithAI = async () => {
  if (!analysisResult.value?.content) {
    ElMessage.warning('没有可分析的内容')
    return
  }
  
  try {
    const message = `请分析以下文档内容：\n\n${analysisResult.value.content.substring(0, 2000)}${analysisResult.value.content.length > 2000 ? '...' : ''}`
    await wsStore.sendMessage(message)
    activeTab.value = 'realtime'
    ElMessage.success('已发送给AI进行智能处理')
  } catch (error) {
    ElMessage.error('发送分析请求失败')
  }
}

const exportResult = () => {
  ElMessage.info('导出功能开发中...')
}

const clearResult = () => {
  wsStore.clearAnalysisResult()
  ElMessage.success('解析结果已清空')
}

// 新增的辅助方法
const getDocumentTypeText = (type) => {
  const typeMap = {
    'requirements': '需求文档',
    'design': '设计文档',
    'general': '通用文档'
  }
  return typeMap[type] || '未知类型'
}

const getLanguageText = (language) => {
  const languageMap = {
    'chinese': '中文',
    'english': '英文',
    'unknown': '未知语言'
  }
  return languageMap[language] || language
}

const getAnalysisTypeText = (type) => {
  const typeMap = {
    'comprehensive': '全面分析',
    'summary': '摘要分析',
    'requirements': '需求分析',
    'custom': '自定义分析'
  }
  return typeMap[type] || type
}

const formatAIResponse = (response) => {
  if (!response) return ''
  
  return response
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code>$1</code>')
    .replace(/#{1,6}\s*(.*?)(?=\n|$)/g, '<h6>$1</h6>')
    .replace(/^\d+\.\s*(.*?)(?=\n|$)/gm, '<li>$1</li>')
    .replace(/^-\s*(.*?)(?=\n|$)/gm, '<li>$1</li>')
}

// 创建markdown渲染器实例
const md = new MarkdownIt({
  html: true,
  linkify: true,
  typographer: true
})

// 设计方案相关方法
const isMarkdownContent = (content) => {
  if (!content) return false
  // 简单检测是否包含markdown语法
  return content.includes('#') || content.includes('**') || content.includes('- ') || content.includes('1. ')
}

const getDesignPlanStats = (content) => {
  if (!content) return null
  
  // 计算章节数量（以#开头的行）
  const sections = (content.match(/^#+\s+/gm) || []).length
  
  return {
    length: content.length,
    sections: sections
  }
}

// renderMarkdown方法
const renderMarkdown = (content) => {
  if (!content) return ''
  return md.render(content)
}

const exportDesignPlanPDF = async () => {
  if (!analysisResult.value?.markdownContent) {
    ElMessage.warning('没有可导出的设计方案')
    return
  }
  
  try {
    const fileName = getAnalysisFileName().replace(/\.[^/.]+$/, "")
    const pdfFileName = `${fileName}_设计方案_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`
    
    // 找到设计方案的容器元素
    const designContainer = document.querySelector('.design-plan-content')
    
    if (!designContainer) {
      ElMessage.error('找不到设计方案内容，请确保您在"设计方案"页签中')
      return
    }
    
    await exportDOMContentToPDF(designContainer, pdfFileName, {
      onProgress: (message) => {
        ElMessage({
          message: message,
          type: 'info',
          duration: 2000
        })
      },
      onSuccess: () => {
        ElMessage.success('设计方案PDF导出成功！')
      },
      onError: (error) => {
        ElMessage.error('导出失败: ' + error.message)
      }
    })
  } catch (error) {
    ElMessage.error('导出设计方案PDF失败: ' + error.message)
  }
}

// Markdown编辑功能相关方法
const toggleEditMode = () => {
  if (!analysisResult.value?.markdownContent) {
    ElMessage.warning('没有可编辑的内容')
    return
  }
  
  // 保存原始内容
  originalMarkdownContent.value = analysisResult.value.markdownContent
  editingMarkdownContent.value = analysisResult.value.markdownContent
  isEditingMarkdown.value = true
  
  ElMessage.success('已进入编辑模式')
}

const cancelEditMode = () => {
  // 检查是否有未保存的更改
  if (editingMarkdownContent.value !== originalMarkdownContent.value) {
    ElMessageBox.confirm(
      '您有未保存的更改，确定要取消编辑吗？',
      '确认取消',
      {
        confirmButtonText: '确定',
        cancelButtonText: '继续编辑',
        type: 'warning',
      }
    ).then(() => {
      // 确认取消，重置状态
      isEditingMarkdown.value = false
      editingMarkdownContent.value = ''
      originalMarkdownContent.value = ''
      ElMessage.info('已取消编辑')
    }).catch(() => {
      // 继续编辑，不做任何操作
    })
  } else {
    // 没有更改，直接取消
    isEditingMarkdown.value = false
    editingMarkdownContent.value = ''
    originalMarkdownContent.value = ''
    ElMessage.info('已取消编辑')
  }
}

const saveMarkdownContent = async () => {
  if (!editingMarkdownContent.value.trim()) {
    ElMessage.warning('内容不能为空')
    return
  }
  
  try {
    isSavingMarkdown.value = true
    
    // 获取当前任务ID
    const taskId = wsStore.currentParsingTask?.id
    if (!taskId) {
      ElMessage.error('无法获取任务ID，请重新分析文档')
      return
    }
    
    // 直接使用独立的axios实例，避免store的api问题
    const response = await apiClient.put(`/api/file/markdown/${taskId}`, {
      markdown_content: editingMarkdownContent.value
    })
    
    if (response.data.success) {
      // 更新本地数据
      analysisResult.value.markdownContent = editingMarkdownContent.value
      
      // 退出编辑模式
      isEditingMarkdown.value = false
      editingMarkdownContent.value = ''
      originalMarkdownContent.value = ''
      
      ElMessage.success('设计方案保存成功！')
    } else {
      ElMessage.error('保存失败: ' + (response.data.error || '未知错误'))
    }
  } catch (error) {
    console.error('保存markdown失败:', error)
    ElMessage.error('保存失败: ' + (error.response?.data?.error || error.message || '网络错误'))
  } finally {
    isSavingMarkdown.value = false
  }
}

const onMarkdownEdit = () => {
  // 可以在这里添加实时保存或其他逻辑
}

const insertMarkdownSyntax = (before, after = '') => {
  // 获取textarea元素
  const textarea = document.querySelector('.markdown-editor textarea')
  if (!textarea) return
  
  const start = textarea.selectionStart
  const end = textarea.selectionEnd
  const selectedText = editingMarkdownContent.value.substring(start, end)
  
  // 构造新文本
  const newText = before + selectedText + after
  
  // 更新内容
  editingMarkdownContent.value = 
    editingMarkdownContent.value.substring(0, start) + 
    newText + 
    editingMarkdownContent.value.substring(end)
  
  // 重新设置光标位置
  nextTick(() => {
    textarea.focus()
    const newCursorPos = start + before.length + selectedText.length + after.length
    textarea.setSelectionRange(newCursorPos, newCursorPos)
  })
}

// 图片链接处理方法

// 后处理图片链接 - 在markdown渲染之后处理
const postProcessImageLinks = (htmlContent) => {
  if (!htmlContent) return ''
  
  // 图片文件扩展名正则
  const imageExtensions = /\.(jpg|jpeg|png|gif|bmp|webp|svg)(\?[^\s]*)?$/i
  
  // 第一步：处理HTML中的链接标签
  let processed = htmlContent.replace(/<a\s+[^>]*href=["']([^"']+)["'][^>]*>([^<]+)<\/a>/g, (match, url, linkText) => {
    // 检查URL是否为图片
    if (imageExtensions.test(url)) {
      const fileName = url.split('/').pop().split('?')[0]
      const imageId = `img-${Math.random().toString(36).substr(2, 9)}`
      
      // 返回图片容器而不是链接
      return `<div class="document-image-container">
<img 
  id="${imageId}"
  src="${url}" 
  alt="文档图片" 
  class="document-image" 
  onclick="previewDocumentImage('${url}', '${imageId}')"
  onerror="this.style.display='none'; this.nextSibling.style.display='inline';" 
/>
<span style="display:none; color: #f56c6c; font-size: 12px;">
  图片加载失败: <a href="${url}" target="_blank" style="color: #409eff;">${url}</a>
</span>
<div class="image-info">
  <span class="image-label">📷 文档图片</span>
  <span class="image-url">${fileName}</span>
</div>
</div>`
    }
    
    // 如果不是图片，保持原来的链接
    return match
  })
  
  // 第二步：处理普通文本中的图片URL（不在HTML标签内的）
  processed = processed.replace(/(^|[^"'>])(https?:\/\/[^\s<>"']+)/g, (match, prefix, url) => {
    // 检查URL是否为图片，且不在HTML标签内
    if (imageExtensions.test(url) && !match.includes('src=') && !match.includes('href=')) {
      const fileName = url.split('/').pop().split('?')[0]
      const imageId = `img-${Math.random().toString(36).substr(2, 9)}`
      
      // 返回图片容器
      return `${prefix}<div class="document-image-container">
<img 
  id="${imageId}"
  src="${url}" 
  alt="文档图片" 
  class="document-image" 
  onclick="previewDocumentImage('${url}', '${imageId}')"
  onerror="this.style.display='none'; this.nextSibling.style.display='inline';" 
/>
<span style="display:none; color: #f56c6c; font-size: 12px;">
  图片加载失败: <a href="${url}" target="_blank" style="color: #409eff;">${url}</a>
</span>
<div class="image-info">
  <span class="image-label">📷 文档图片</span>
  <span class="image-url">${fileName}</span>
</div>
</div>`
    }
    
    // 如果不是图片或已在标签内，保持原样
    return match
  })
  
  return processed
}

// 预处理图片链接 - 在markdown渲染之前处理
const preprocessImageLinks = (content) => {
  if (!content) return ''
  
  // 图片文件扩展名正则 - 更严格的匹配
  const imageExtensions = /\.(jpg|jpeg|png|gif|bmp|webp|svg)(\?[^\s]*)?$/i
  
  // 分行处理，避免重复替换
  const lines = content.split('\n')
  let processed = []
  
  for (let line of lines) {
    // 跳过已经处理过的内容
    if (line.includes('document-image-container') || 
        line.includes('![') || 
        line.includes('<img')) {
      processed.push(line)
      continue
    }
    
    // 检查是否整行都是图片URL
    const trimmedLine = line.trim()
    const fullUrlMatch = trimmedLine.match(/^(https?:\/\/[^\s]+)$/)
    
    if (fullUrlMatch && imageExtensions.test(fullUrlMatch[1])) {
      const imageUrl = fullUrlMatch[1]
      const fileName = imageUrl.split('/').pop().split('?')[0] // 去掉query参数
      const imageId = `img-${Math.random().toString(36).substr(2, 9)}`
      
      // 转换为自定义的图片显示格式
      processed.push(`<div class="document-image-container">
<img 
  id="${imageId}"
  src="${imageUrl}" 
  alt="文档图片" 
  class="document-image" 
  onclick="previewDocumentImage('${imageUrl}', '${imageId}')"
  onerror="this.style.display='none'; this.nextSibling.style.display='inline';" 
/>
<span style="display:none; color: #f56c6c; font-size: 12px;">
  图片加载失败: <a href="${imageUrl}" target="_blank" style="color: #409eff;">${imageUrl}</a>
</span>
<div class="image-info">
  <span class="image-label">📷 文档图片</span>
  <span class="image-url">${fileName}</span>
</div>
</div>`)
      continue
    }
    
    // 对于其他行，保持原样
    processed.push(line)
  }
  
  return processed.join('\n')
}

// 图片预览功能
const previewDocumentImage = (imageSrc, imageId) => {
  // 创建图片预览对话框
  const dialog = document.createElement('div')
  dialog.className = 'image-preview-dialog'
  dialog.innerHTML = `
    <div class="image-preview-overlay" onclick="closeImagePreview()">
      <div class="image-preview-content" onclick="event.stopPropagation()">
        <div class="image-preview-header">
          <span class="image-preview-title">图片预览</span>
          <button class="image-preview-close" onclick="closeImagePreview()">×</button>
        </div>
        <div class="image-preview-body">
          <img src="${imageSrc}" alt="图片预览" class="preview-image" />
        </div>
        <div class="image-preview-footer">
          <button class="preview-btn" onclick="window.open('${imageSrc}', '_blank')">在新窗口打开</button>
          <button class="preview-btn" onclick="downloadImage('${imageSrc}')">下载图片</button>
          <button class="preview-btn" onclick="copyImageUrl('${imageSrc}')">复制链接</button>
        </div>
      </div>
    </div>
  `
  
  document.body.appendChild(dialog)
  
  // 添加样式
  if (!document.querySelector('#image-preview-styles')) {
    const style = document.createElement('style')
    style.id = 'image-preview-styles'
    style.textContent = `
      .image-preview-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
      }
      
      .image-preview-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      
      .image-preview-content {
        background: white;
        border-radius: 8px;
        max-width: 90vw;
        max-height: 90vh;
        cursor: default;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      
      .image-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #e4e7ed;
        background: #f8f9fa;
      }
      
      .image-preview-title {
        font-weight: 600;
        color: #303133;
      }
      
      .image-preview-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #909399;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
      }
      
      .image-preview-close:hover {
        background: #e4e7ed;
        color: #606266;
      }
      
      .image-preview-body {
        padding: 20px;
        text-align: center;
        max-height: 70vh;
        overflow: auto;
      }
      
      .preview-image {
        max-width: 100%;
        max-height: 100%;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .image-preview-footer {
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 16px 20px;
        border-top: 1px solid #e4e7ed;
        background: #f8f9fa;
      }
      
      .preview-btn {
        padding: 8px 16px;
        border: 1px solid #dcdfe6;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        color: #606266;
        transition: all 0.3s;
      }
      
      .preview-btn:hover {
        border-color: #409eff;
        color: #409eff;
      }
    `
    document.head.appendChild(style)
  }
}

// 全局函数定义，供HTML中的onclick使用（在onMounted中设置）
const closeImagePreview = () => {
  const dialog = document.querySelector('.image-preview-dialog')
  if (dialog) {
    dialog.remove()
  }
}

const downloadImage = (imageSrc) => {
  const a = document.createElement('a')
  a.href = imageSrc
  a.download = imageSrc.split('/').pop()
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
}

const copyImageUrl = async (imageSrc) => {
  try {
    await navigator.clipboard.writeText(imageSrc)
    ElMessage.success('图片链接已复制到剪贴板')
  } catch (error) {
    ElMessage.error('复制失败')
  }
}

// Markdown操作方法
const copyMarkdownContent = async () => {
  if (!analysisResult.value?.markdownContent) {
    ElMessage.warning('没有可复制的报告内容')
    return
  }
  
  try {
    await navigator.clipboard.writeText(analysisResult.value.markdownContent)
    ElMessage.success('分析报告已复制到剪贴板')
  } catch (error) {
    ElMessage.error('复制失败')
  }
}

const downloadMarkdownContent = () => {
  if (!analysisResult.value?.markdownContent) {
    ElMessage.warning('没有可下载的报告内容')
    return
  }
  
  const fileName = getAnalysisFileName().replace(/\.[^/.]+$/, "") // 移除原文件扩展名
  const blob = new Blob([analysisResult.value.markdownContent], { type: 'text/markdown;charset=utf-8' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `${fileName}_analysis_report.md`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
  ElMessage.success('分析报告下载开始')
}

const formatSummary = (summary) => {
  if (!summary) return ''
  return summary.replace(/\n/g, '<br>')
}

const copySummary = async () => {
  if (!analysisResult.value?.analysisSummary) {
    ElMessage.warning('没有可复制的总结内容')
    return
  }
  
  try {
    await navigator.clipboard.writeText(analysisResult.value.analysisSummary)
    ElMessage.success('总结已复制到剪贴板')
  } catch (error) {
    ElMessage.error('复制失败')
  }
}

const getAnalysisFileName = () => {
  // 优先使用后端返回的fileFormat.fileName
  return analysisResult.value?.fileFormat?.fileName || 
         analysisResult.value?.fileInfo?.name || 
         '未知文件'
}

const getAnalysisFileType = () => {
  return analysisResult.value?.fileInfo?.type || analysisResult.value?.details?.type || '未知类型'
}

const getAnalysisFileSize = () => {
  return formatFileSize(analysisResult.value?.fileInfo?.size || 0)
}

const getAnalysisCharacterCount = () => {
  return analysisResult.value?.contentAnalysis?.statistics?.character_count || 
         analysisResult.value?.details?.length || 0
}

// 代码生成方法
const generateCode = async () => {
  if (!analysisResult.value?.markdownContent) {
    ElMessage.warning('没有设计方案内容可生成代码')
    return
  }
  
  isGeneratingCode.value = true
  
  try {
    const projectName = getAnalysisFileName().replace(/\.[^/.]+$/, "") // 移除文件扩展名
    
    const response = await apiClient.post('/api/coder-agent/process-document', {
      document_content: analysisResult.value.markdownContent,
      project_name: projectName
    })
    
    if (response.data.status === 'success') {
      ElMessage.success('代码生成成功！请查看后端输出目录')
      
      // 可以在这里添加更多成功后的处理逻辑
      // 比如显示生成的文件列表、提供下载链接等
      if (response.data.data) {
        console.log('生成结果:', response.data.data)
      }
    } else {
      ElMessage.error('代码生成失败: ' + (response.data.message || '未知错误'))
    }
  } catch (error) {
    console.error('代码生成失败:', error)
    const errorMsg = error.response?.data?.message || error.message || '网络错误'
    ElMessage.error('代码生成失败: ' + errorMsg)
  } finally {
    isGeneratingCode.value = false
  }
}

// 变更分析相关方法
const getChangeTypeColor = (changeType) => {
  const colorMap = {
    '新增': 'success',
    '修改': 'warning', 
    '删除': 'danger',
    '相同': 'info'
  }
  return colorMap[changeType] || 'info'
}

// 正确计算变更项的总数
const getTotalChangesCount = () => {
  if (!analysisResult.value?.contentAnalysis?.change_analysis?.change_analyses) {
    return 0
  }
  
  // 现在每个change_analyses项目就是一个变更，直接返回长度
  return analysisResult.value.contentAnalysis.change_analysis.change_analyses.length
}
</script>

<style lang="scss" scoped>
.chat-container {
  display: flex;
  height: 100vh;
  background: #f5f7fa;
}

.sidebar {
  width: 400px;
  background: white;
  border-right: 1px solid #e4e7ed;
  display: flex;
  flex-direction: column;
  height: 100vh;

  .sidebar-header {
    flex: 0 0 auto;
    padding: 20px;
    border-bottom: 1px solid #e4e7ed;
    background: white;

    .app-title {
      display: flex;
      align-items: center;
      margin: 0 0 16px 0;
      font-size: 20px;
      font-weight: 600;
      color: #303133;

      .el-icon {
        margin-right: 8px;
        color: #409eff;
      }
    }

    .new-chat-btn {
      width: 100%;
    }
  }

  .chat-history {
    flex: 0 0 auto;
    padding: 20px;
    overflow: hidden;

    .history-section {
      margin-bottom: 16px;

      h3 {
        font-size: 16px;
        font-weight: 600;
        color: #303133;
        margin: 0 0 6px 0;
      }

      .section-subtitle {
        font-size: 14px;
        color: #909399;
        margin: 0;
      }
    }

    .task-description {
      margin-bottom: 16px;

      h4 {
        font-size: 14px;
        font-weight: 600;
        color: #303133;
        margin: 0 0 8px 0;
      }

      p {
        font-size: 13px;
        color: #606266;
        line-height: 1.5;
        margin: 0 0 8px 0;
      }
    }

    .feature-tips {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e4e7ed;

      p {
        font-size: 13px;
        color: #606266;
        font-weight: 500;
        margin: 0;
      }
    }
  }

  .chat-messages {
    flex: 1;
    padding: 15px 20px;
    overflow-y: auto;
    min-height: 0;
    max-height: calc(100vh - 400px); /* 为输入区域预留更多空间 */

    .message {
      margin-bottom: 16px;

      &.user {
        .user-message {
          display: flex;
          flex-direction: column;
          align-items: flex-end;

          .message-content {
            background: #409eff;
            color: white;
            padding: 12px 16px;
            border-radius: 18px 18px 4px 18px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
          }

          .message-time {
            font-size: 12px;
            color: #909399;
            margin-top: 4px;
          }
        }
      }

      &.chat_response {
        .bot-message {
          display: flex;
          align-items: flex-start;

          .bot-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;

            .el-icon {
              color: #606266;
            }
          }

          .message-content {
            flex: 1;

            .message-text {
              background: white;
              padding: 12px 16px;
              border-radius: 4px 18px 18px 18px;
              border: 1px solid #e4e7ed;
              font-size: 14px;
              line-height: 1.6;
              color: #303133;
            }

            .message-time {
              font-size: 12px;
              color: #909399;
              margin-top: 4px;
            }
          }
        }
      }
    }

    .typing-indicator {
      display: flex;
      align-items: flex-start;

      .bot-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;

        .el-icon {
          color: #606266;
        }
      }

      .typing-dots {
        background: white;
        padding: 12px 16px;
        border-radius: 4px 18px 18px 18px;
        border: 1px solid #e4e7ed;
        display: flex;
        align-items: center;

        span {
          width: 6px;
          height: 6px;
          border-radius: 50%;
          background: #c0c4cc;
          margin: 0 2px;
          animation: typing 1.4s infinite ease-in-out;

          &:nth-child(1) { animation-delay: -0.32s; }
          &:nth-child(2) { animation-delay: -0.16s; }
        }
      }
    }
  }

  .chat-input {
    flex: 0 0 auto;
    padding: 20px;
    border-top: 1px solid #e4e7ed;
    background: white;
    min-height: 160px; /* 确保有足够的高度显示按钮 */

    .input-container {
      .uploaded-file-card {
        margin-bottom: 12px;
        background: #ffffff;
        border: 1px solid #e4e7ed;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
        overflow: hidden;
        
        &:hover {
          border-color: #409eff;
          box-shadow: 0 4px 16px rgba(64, 158, 255, 0.15);
        }
        
        .file-card-header {
          display: flex;
          align-items: center;
          padding: 12px 16px 8px 16px;
          
          .file-icon {
            flex-shrink: 0;
            margin-right: 8px;
            color: #409eff;
            font-size: 16px;
          }
          
          .file-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #303133;
            word-break: break-all;
            overflow-wrap: break-word;
            line-height: 1.4;
          }
          
          .close-btn {
            flex-shrink: 0;
            padding: 4px;
            color: #909399;
            
            &:hover {
              color: #f56c6c;
            }
            
            :deep(.el-icon) {
              font-size: 14px;
            }
          }
        }
        
        .file-card-footer {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 16px 12px 16px;
          background: #f8f9fa;
          border-top: 1px solid #f0f0f0;
          
          .file-size {
            font-size: 12px;
            color: #909399;
          }
          
          .analyze-btn {
            border-radius: 4px;
            font-size: 12px;
            padding: 4px 12px;
            height: 28px;
            
            :deep(.el-icon) {
              font-size: 12px;
            }
          }
        }

      }
      
      .input-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
        padding: 8px 0; /* 添加内边距 */
        min-height: 40px; /* 确保按钮区域有足够高度 */
      }
    }
  }
}

.agent-workspace {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
  width: 100%;
  min-width: 0; /* 确保flex子元素能够收缩 */

  .workspace-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    border-bottom: 1px solid #e4e7ed;
    background: white;

    h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #303133;
    }
  }

  .workspace-tabs {
    flex: 1;
    padding: 0;
    overflow-y: auto;
    width: 100%;
    min-width: 0; /* 确保flex子元素能够收缩 */

    :deep(.el-tabs__header) {
      margin: 0;
      padding: 0 24px;
      background: #fafbfc;
      border-bottom: 1px solid #e4e7ed;
    }

    :deep(.el-tabs__content) {
      padding: 0;
      height: calc(100vh - 120px);
      overflow-y: hidden;
      width: 100%;
    }

    .tab-content {
      padding: 16px 24px;
      height: calc(120vh - 180px);
      overflow-y: auto;
      width: 100%;
      box-sizing: border-box;

      .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;

        h4 {
          font-size: 16px;
          font-weight: 600;
          color: #303133;
          margin: 0;
        }
      }

      .processing-steps {
        margin-bottom: 20px;

        :deep(.el-timeline-item__content) {
          .step-content {
            h5 {
              font-size: 14px;
              font-weight: 600;
              color: #303133;
              margin: 0 0 8px 0;
            }

            p {
              font-size: 13px;
              color: #606266;
              margin: 0 0 8px 0;
            }

            .step-progress {
              margin-top: 8px;
            }
          }
        }
      }

      .current-processing {
        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;

          .rotating {
            animation: rotate 2s linear infinite;
          }
        }
      }

      .analysis-result {
        height: 100%;
        display: flex;
        flex-direction: column;
        width: 100%;
        min-width: 0; /* 确保flex子元素能够收缩 */
        
        .result-header {
          margin-bottom: 20px;
          width: 100%;

          .result-title {
            h4 {
              font-size: 18px;
              font-weight: 600;
              color: #303133;
              margin: 0 0 8px 0;
              display: flex;
              align-items: center;
              
              // 文件图标样式
              &:first-child {
                margin-right: 8px;
              }
            }
          }

          .result-meta {
            display: flex;
            align-items: center;
            gap: 12px;

            .result-time {
              font-size: 13px;
              color: #909399;
            }
          }
        }

        .result-content {
          width: 100%;
          min-width: 0; /* 确保flex子元素能够收缩 */
          
          .info-card {
            margin-bottom: 16px;
            width: 100%;

            :deep(.el-card__header) {
              padding: 12px 16px;
              background: #fafbfc;

              h5 {
                font-size: 14px;
                font-weight: 600;
                color: #303133;
                margin: 0;
              }
            }

            :deep(.el-card__body) {
              padding: 16px;
              word-wrap: break-word;
              word-break: break-all;
              overflow-wrap: break-word;
            }

            .analysis-content {
              font-size: 14px;
              line-height: 1.6;
              color: #303133;
              width: 100%;
              word-wrap: break-word;
              word-break: break-all;
              overflow-wrap: break-word;

              h4 {
                font-size: 16px;
                font-weight: 600;
                color: #303133;
                margin: 16px 0 8px 0;
                word-wrap: break-word;
              }

              ul {
                margin: 8px 0;
                padding-left: 20px;
                width: 100%;
              }

              li {
                margin: 4px 0;
                word-wrap: break-word;
                word-break: break-all;
                overflow-wrap: break-word;
              }
            }

            .suggestions-content {
              ul {
                margin: 0;
                padding-left: 20px;

                li {
                  font-size: 14px;
                  color: #606266;
                  line-height: 1.6;
                  margin: 8px 0;
                }
              }
            }
          }
        }
      }

      .document-preview {
        width: 100%;
        min-width: 0; /* 确保flex子元素能够收缩 */
        
        .preview-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          width: 100%;
          padding-bottom: 12px;
          border-bottom: 1px solid #e4e7ed;

          h4 {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            margin: 0;
          }

          .file-info {
            display: flex;
            align-items: center;
            gap: 8px;

            .file-size {
              font-size: 12px;
              color: #909399;
            }
          }
        }

        .preview-content {
          .text-preview {
            .file-content {
              background: #f8f9fa;
              border: 1px solid #e4e7ed;
              border-radius: 6px;
              padding: 16px;
              margin-bottom: 20px;

              pre {
                margin: 0;
                font-family: 'Courier New', monospace;
                font-size: 13px;
                line-height: 1.5;
                color: #303133;
                white-space: pre-wrap;
                word-wrap: break-word;
              }
            }

            .loading-content {
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              padding: 40px;
              color: #909399;

              .el-icon {
                font-size: 24px;
                margin-bottom: 12px;
              }

              p {
                margin: 0;
                font-size: 14px;
              }
            }
          }

          .binary-preview {
            .file-info-display {
              margin-bottom: 20px;

              .document-icon {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 16px;

                .el-icon {
                  margin-bottom: 8px;
                }

                .icon-text {
                  font-size: 14px;
                  font-weight: 600;
                  color: #303133;
                  margin: 0;
                }
              }

              .preview-notice {
                margin-top: 16px;

                :deep(.el-alert__content) {
                  .notice-content {
                    p {
                      margin: 8px 0;
                      font-size: 13px;
                      line-height: 1.5;

                      strong {
                        color: #303133;
                        font-weight: 600;
                      }
                    }

                    ul {
                      margin: 8px 0;
                      padding-left: 20px;

                      li {
                        margin: 4px 0;
                        font-size: 13px;
                        line-height: 1.4;
                        color: #67c23a;
                      }
                    }
                  }
                }
              }
            }
          }

          .preview-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid #e4e7ed;
          }
        }
      }

      .empty-state {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 400px;
      }

      .export-options {
        .export-card {
          margin-bottom: 20px;

          :deep(.el-card__header) {
            padding: 16px 20px;
            background: #fafbfc;

            .card-header {
              display: flex;
              align-items: center;
              font-size: 16px;
              font-weight: 600;
              color: #303133;

              .el-icon {
                margin-right: 8px;
                color: #409eff;
              }
            }
          }

          :deep(.el-card__body) {
            padding: 20px;

            p {
              font-size: 14px;
              color: #606266;
              line-height: 1.6;
              margin: 0 0 16px 0;
            }

            .export-actions {
              display: flex;
              justify-content: flex-end;
              gap: 8px;
            }

            .custom-export {
              :deep(.el-checkbox-group) {
                display: flex;
                flex-direction: column;
                gap: 8px;
              }
            }
          }
        }
      }
    }
  }
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-10px);
  }
}

@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

// 响应式设计
@media (max-width: 768px) {
  .chat-container {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    height: 50vh;
    
    .chat-input {
      .input-container {
        .uploaded-file-info {
          flex-direction: column;
          align-items: stretch;
          
          .file-info-container {
            max-width: 100%;
            margin-bottom: 8px;
            
            .file-details {
              .file-name {
                font-size: 13px;
              }
            }
          }
          
          .analyze-btn {
            width: 100%;
            align-self: stretch;
          }
        }
      }
    }
  }
  
  .agent-workspace {
    height: 50vh;
  }
  
  // 移动端悬浮按钮优化
  .result-actions-float {
    padding: 12px 16px;
    gap: 8px;
    
    .el-button {
      flex: 1;
      max-width: none;
      height: 32px;
      font-size: 12px;
      
      .el-icon {
        font-size: 14px;
      }
    }
  }
}

// 结果容器样式
.results-container {
  position: relative;
  height: calc(100vh - 400px);
  display: flex;
  flex-direction: column;
  width: 100%;
  min-width: 0; /* 确保flex子元素能够收缩 */
  box-sizing: border-box;
}

// 悬浮操作按钮样式
.result-actions-float {
  position: sticky;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: center;
  gap: 12px;
  padding: 16px 20px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-top: 1px solid #e4e7ed;
  border-radius: 12px 12px 0 0;
  box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.1);
  z-index: 100;
  transition: all 0.3s ease;
  
  &:hover {
    background: rgba(255, 255, 255, 0.98);
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
  }
  
  .el-button {
    flex: 1;
    max-width: 120px;
    height: 36px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    
    &:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    &.el-button--primary {
      background: linear-gradient(135deg, #409eff, #1890ff);
      border: none;
      
      &:hover {
        background: linear-gradient(135deg, #1890ff, #096dd9);
      }
    }
  }
}

// 内容分析结果样式
.content-analysis-result {
  .analysis-section {
    margin-bottom: 16px;
    
    h6 {
      font-size: 14px;
      font-weight: 600;
      color: #303133;
      margin: 0 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e4e7ed;
    }
    
    .summary-text {
      font-size: 14px;
      line-height: 1.6;
      color: #606266;
      margin: 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #409eff;
    }
    
    .keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      
      .keyword-tag {
        margin: 0;
      }
    }
  }
}

// 文档结构摘要样式
.document-summary {
  .summary-section {
    margin-bottom: 16px;
    
    h6 {
      font-size: 14px;
      font-weight: 600;
      color: #303133;
      margin: 0 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e4e7ed;
    }
    
    .abstract-text {
      font-size: 14px;
      line-height: 1.6;
      color: #606266;
      margin: 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #52c41a;
    }
  }
  
  .function-list, .api-list {
    margin-bottom: 16px;
    
    h6 {
      font-size: 14px;
      font-weight: 600;
      color: #303133;
      margin: 0 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e4e7ed;
    }
  }
}

// 关键词分析样式
.keyword-analysis {
  .keywords-section {
    margin-bottom: 16px;
    
    h6 {
      font-size: 14px;
      font-weight: 600;
      color: #303133;
      margin: 0 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e4e7ed;
    }
  }
  
  .primary-keywords {
    margin-bottom: 16px;
    
    h6 {
      font-size: 14px;
      font-weight: 600;
      color: #303133;
      margin: 0 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e4e7ed;
    }
    
    :deep(.el-table) {
      border-radius: 6px;
      overflow: hidden;
      
      .el-table__header {
        background: #f8f9fa;
        
        th {
          background: #f8f9fa;
          color: #303133;
          font-weight: 600;
        }
      }
      
      .el-table__body {
        tr:hover {
          background: #f0f9ff;
        }
      }
    }
  }
  
  .semantic-clusters {
    h6 {
      font-size: 14px;
      font-weight: 600;
      color: #303133;
      margin: 0 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e4e7ed;
    }
    
    .cluster-item {
      margin-bottom: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #faad14;
      
      .cluster-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        
        .cluster-name {
          font-size: 14px;
          font-weight: 600;
          color: #303133;
        }
      }
      
      .cluster-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
    }
  }
}

// AI分析结果样式
.ai-analysis-result {
  .ai-analysis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    
    h5 {
      margin: 0;
    }
  }
  
  .ai-response-content {
    margin-top: 16px;
    
    h6 {
      font-size: 14px;
      font-weight: 600;
      color: #303133;
      margin: 0 0 12px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e4e7ed;
    }
    
    .ai-response-text {
      background: #f8f9fa;
      border: 1px solid #e4e7ed;
      border-radius: 6px;
      padding: 16px;
      
      :deep(h6) {
        color: #409eff;
        font-weight: 600;
        margin: 16px 0 8px 0;
        
        &:first-child {
          margin-top: 0;
        }
      }
      
      :deep(strong) {
        color: #303133;
        font-weight: 600;
      }
      
      :deep(em) {
        color: #606266;
        font-style: italic;
      }
      
      :deep(code) {
        background: #e6f7ff;
        color: #1890ff;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
      }
      
      :deep(li) {
        margin: 4px 0;
        color: #606266;
        line-height: 1.5;
      }
    }
  }
  
  .custom-prompt-section {
    margin-top: 16px;
    
    h6 {
      font-size: 14px;
      font-weight: 600;
      color: #303133;
      margin: 0 0 8px 0;
    }
    
    .custom-prompt-text {
      font-size: 13px;
      color: #909399;
      background: #f5f7fa;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 0;
      font-style: italic;
    }
  }
}

// Markdown样式
.markdown-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

// 内容分析结果样式
.content-analysis-result {
  .content-analysis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    
    h5 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #303133;
    }
  }
  
  .metadata-section {
    margin-bottom: 20px;
  }
  
  .change-analysis-section {
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #303133;
      margin: 0 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #409eff;
    }
    
    .subsection-title {
      font-size: 14px;
      font-weight: 600;
      color: #606266;
      margin: 20px 0 12px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e4e7ed;
    }
    
    .analysis-summary-card {
      margin-bottom: 20px;
      
      .summary-card {
        .summary-header {
          font-size: 14px;
          font-weight: 600;
          color: #303133;
        }
        
        .summary-item {
          text-align: center;
          padding: 16px;
          
          .summary-number {
            font-size: 28px;
            font-weight: 700;
            color: #409eff;
            margin-bottom: 8px;
          }
          
          .summary-label {
            font-size: 12px;
            color: #909399;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
        }
      }
    }
    
    .change-details-section, .deletion-section {
      margin-bottom: 20px;
      
      .change-items, .deletion-items {
        display: flex;
        flex-direction: column;
        gap: 12px;
        
        .change-item-card, .deletion-item-card {
          border-radius: 8px;
          transition: all 0.3s ease;
          
          &:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
          }
          
          :deep(.el-card__header) {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
            
            .change-item-header, .deletion-item-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              
              .change-index, .deletion-index {
                font-size: 12px;
                font-weight: 600;
                color: #6c757d;
                background: #e9ecef;
                padding: 4px 8px;
                border-radius: 12px;
              }
            }
          }
          
          .change-content, .deletion-content {
            .change-reason, .deletion-analysis {
              margin-bottom: 16px;
              
              strong {
                color: #495057;
                font-weight: 600;
              }
              
              p {
                margin: 8px 0 0 0;
                line-height: 1.6;
                color: #6c757d;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 6px;
                border-left: 4px solid #007bff;
              }
            }
            
            .change-items-list {
              margin-bottom: 16px;
              
              strong {
                color: #495057;
                font-weight: 600;
              }
              
              ul {
                margin: 8px 0 0 0;
                padding-left: 0;
                list-style: none;
                
                li {
                  position: relative;
                  padding: 8px 0 8px 24px;
                  margin: 4px 0;
                  color: #6c757d;
                  line-height: 1.5;
                  
                  &:before {
                    content: '•';
                    position: absolute;
                    left: 8px;
                    color: #007bff;
                    font-weight: bold;
                  }
                }
              }
            }
            
            .version-info, .deletion-section-info {
              display: flex;
              align-items: center;
              gap: 8px;
              
              strong {
                color: #495057;
                font-weight: 600;
              }
            }
            
            .deleted-item {
              margin-bottom: 12px;
              
              strong {
                color: #495057;
                font-weight: 600;
              }
              
              .deleted-text {
                margin-left: 8px;
                padding: 4px 8px;
                background: #fff5f5;
                border: 1px solid #feb2b2;
                border-radius: 4px;
                color: #c53030;
                font-weight: 500;
              }
            }
          }
        }
      }
    }
    
    .empty-changes {
      padding: 40px 20px;
      text-align: center;
      
      :deep(.el-empty__description) {
        color: #909399;
        font-size: 14px;
      }
    }
  }
}

// 分析总结样式
.summary-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  
  h5 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #303133;
  }
}

.summary-content {
  .summary-text {
    font-size: 14px;
    line-height: 1.8;
    color: #606266;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #67c23a;
    margin: 0;
    
    :deep(br) {
      margin-bottom: 8px;
    }
    
    :deep(strong) {
      color: #303133;
      font-weight: 600;
    }
    
    :deep(em) {
      color: #909399;
      font-style: italic;
    }
  }
}

.markdown-content {
  .markdown-preview {
    padding: 16px;
    background: #fafafa;
    border-radius: 6px;
    
    :deep(h1), :deep(h2), :deep(h3), :deep(h4), :deep(h5), :deep(h6) {
      color: #303133;
      margin: 16px 0 8px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #e4e7ed;
      font-weight: 600;
    }
    
    :deep(h1) { font-size: 28px; }
    :deep(h2) { font-size: 24px; }
    :deep(h3) { font-size: 20px; }
    :deep(h4) { font-size: 18px; }
    :deep(h5) { font-size: 16px; }
    :deep(h6) { font-size: 14px; }
    
    :deep(p) {
      margin: 8px 0;
      line-height: 1.6;
      color: #606266;
    }
    
    :deep(ul), :deep(ol) {
      margin: 8px 0;
      padding-left: 24px;
      
      li {
        margin: 4px 0;
        line-height: 1.5;
        color: #606266;
      }
    }
    
    :deep(blockquote) {
      margin: 16px 0;
      padding: 8px 16px;
      background: #f4f4f5;
      border-left: 4px solid #409eff;
      color: #606266;
      font-style: italic;
    }
    
    :deep(code) {
      padding: 2px 4px;
      background: #f1f2f3;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #e6a23c;
    }
    
    :deep(pre) {
      margin: 16px 0;
      padding: 16px;
      background: #2d3748;
      color: #e2e8f0;
      border-radius: 6px;
      overflow-x: auto;
      
      code {
        background: none;
        color: inherit;
        padding: 0;
      }
    }
    
    :deep(table) {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      
      th, td {
        padding: 8px 12px;
        border: 1px solid #e4e7ed;
        text-align: left;
      }
      
      th {
        background: #f5f7fa;
        font-weight: 600;
        color: #303133;
      }
      
      td {
        color: #606266;
      }
    }
    
    :deep(hr) {
      margin: 24px 0;
      border: none;
      border-top: 2px solid #e4e7ed;
    }
    
    :deep(strong) {
      font-weight: 600;
      color: #303133;
    }
    
    :deep(em) {
      font-style: italic;
      color: #909399;
    }
    
    :deep(a) {
      color: #409eff;
      text-decoration: none;
      
      &:hover {
        text-decoration: underline;
      }
    }
  }
}

.no-content {
  color: #909399;
  font-style: italic;
  text-align: center;
  padding: 20px;
}

// 结果容器样式优化
        .results-container {
          flex: 1;
          display: flex;
          flex-direction: column;
        }

// 自适应滚动条样式优化
.analysis-scrollbar {
  flex: 1;
  height: calc(100vh - 400px);
  
  :deep(.el-scrollbar__wrap) {
    overflow-x: hidden;
  }
  
  :deep(.el-scrollbar__view) {
    padding: 0;
  }
}

.ai-content-scrollbar,
.markdown-content-scrollbar,
.document-content-scrollbar {
  :deep(.el-scrollbar__wrap) {
    overflow-x: hidden;
  }
  
  :deep(.el-scrollbar__view) {
    padding: 8px 0;
  }
  
  :deep(.el-scrollbar__bar) {
    .el-scrollbar__thumb {
      background-color: rgba(144, 147, 153, 0.5);
      border-radius: 4px;
      
      &:hover {
        background-color: rgba(144, 147, 153, 0.8);
      }
    }
  }
}

// 不同滚动区域的特殊优化
.ai-content-scrollbar {
  // AI内容区域的特殊样式
  :deep(.el-scrollbar__view) {
    min-height: 200px;
  }
}

.markdown-content-scrollbar {
  // Markdown内容区域的特殊样式
  :deep(.el-scrollbar__view) {
    min-height: 300px;
  }
}

.document-content-scrollbar {
  // 文档内容区域的特殊样式
  :deep(.el-scrollbar__view) {
    min-height: 150px;
  }
  
  .content-text {
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    color: #303133;
    white-space: pre-wrap;
    word-wrap: break-word;
    margin: 0;
  }
}

// 响应式适配
@media (max-width: 1200px) {
  .analysis-scrollbar {
    height: calc(100vh - 420px) !important;
  }
  
  .ai-content-scrollbar {
    max-height: 55vh !important;
  }
  
  .markdown-content-scrollbar {
    max-height: 65vh !important;
  }
  
  .document-content-scrollbar {
    max-height: 45vh !important;
  }
}

@media (max-width: 768px) {
  .analysis-scrollbar {
    height: calc(100vh - 440px) !important;
  }
  
  .ai-content-scrollbar {
    max-height: 50vh !important;
  }
  
  .markdown-content-scrollbar {
    max-height: 60vh !important;
  }
  
  .document-content-scrollbar {
    max-height: 40vh !important;
  }
}

// 变更详情markdown渲染样式
.change-reason-content,
.change-details-content,
.deletion-analysis-content,
.deletion-details-content {
  margin-top: 8px;
  padding: 12px;
  background: #fafafa;
  border-radius: 6px;
  border: 1px solid #e4e7ed;
  
  :deep(h1), :deep(h2), :deep(h3), :deep(h4), :deep(h5), :deep(h6) {
    margin: 12px 0 8px 0;
    color: #303133;
    font-weight: 600;
  }
  
  :deep(h1) { font-size: 18px; }
  :deep(h2) { font-size: 16px; }
  :deep(h3) { font-size: 15px; }
  :deep(h4) { font-size: 14px; }
  :deep(h5) { font-size: 13px; }
  :deep(h6) { font-size: 12px; }
  
  :deep(p) {
    margin: 8px 0;
    line-height: 1.6;
    color: #606266;
  }
  
  :deep(ul), :deep(ol) {
    margin: 8px 0;
    padding-left: 20px;
    color: #606266;
    
    li {
      margin: 4px 0;
      line-height: 1.5;
    }
  }
  
  :deep(blockquote) {
    margin: 8px 0;
    padding: 8px 12px;
    background: #f0f9ff;
    border-left: 3px solid #409eff;
    color: #606266;
    font-style: italic;
  }
  
  :deep(code) {
    padding: 2px 4px;
    background: #f1f2f3;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: #e6a23c;
  }
  
  :deep(pre) {
    margin: 8px 0;
    padding: 12px;
    background: #2d3748;
    color: #e2e8f0;
    border-radius: 4px;
    overflow-x: auto;
    font-size: 12px;
    
    code {
      background: none;
      color: inherit;
      padding: 0;
    }
  }
  
  :deep(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 8px 0;
    font-size: 12px;
    
    th, td {
      padding: 6px 8px;
      border: 1px solid #e4e7ed;
      text-align: left;
    }
    
    th {
      background: #f5f7fa;
      font-weight: 600;
      color: #303133;
    }
    
    td {
      color: #606266;
    }
  }
  
  :deep(hr) {
    margin: 16px 0;
    border: none;
    border-top: 1px solid #e4e7ed;
  }
  
  :deep(strong) {
    font-weight: 600;
    color: #303133;
  }
  
  :deep(em) {
    font-style: italic;
    color: #909399;
  }
  
  :deep(a) {
    color: #409eff;
    text-decoration: none;
    
    &:hover {
      text-decoration: underline;
    }
  }
}

/* 全局自适应宽度样式 - 确保agent-workspace内所有内容都能自适应 */
.agent-workspace {
  * {
    box-sizing: border-box;
  }
  
  /* 确保所有卡片组件自适应宽度 */
  .el-card {
    width: 100% !important;
    
    .el-card__body {
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
      
      * {
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
    }
  }
  
  /* 确保描述列表组件自适应宽度 */
  .el-descriptions {
    width: 100% !important;
    
    .el-descriptions__body {
      width: 100% !important;
    }
    
    .el-descriptions__table {
      width: 100% !important;
      table-layout: fixed;
    }
    
    .el-descriptions__cell {
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
    }
  }
  
  /* 确保所有文本内容自适应 */
  p, div, span, li, td, th, h1, h2, h3, h4, h5, h6 {
    word-wrap: break-word;
    word-break: break-all;
    overflow-wrap: break-word;
    max-width: 100%;
  }
  
  /* 确保列表内容自适应 */
  ul, ol {
    width: 100%;
    padding-left: 20px;
    margin: 0;
    
    li {
      width: calc(100% - 20px);
      margin: 4px 0;
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
    }
  }
  
  /* 确保表格自适应宽度 */
  .el-table {
    width: 100% !important;
    
    .el-table__body-wrapper {
      overflow-x: auto;
    }
    
    .cell {
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
    }
  }
  
  /* 确保标签组自适应 */
  .el-tag {
    max-width: 100%;
    white-space: normal;
    word-wrap: break-word;
    word-break: break-all;
  }
  
  /* 确保分析内容区域自适应 */
  .analysis-content,
  .change-reason-content,
  .change-details-content {
    width: 100%;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-all;
    
    * {
      max-width: 100%;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
  }
  
  /* 文档图片容器样式 */
  :deep(.document-image-container) {
    margin: 16px 0;
    border: 1px solid #e4e7ed;
    border-radius: 8px;
    overflow: hidden;
    background: #fff;
    transition: all 0.3s ease;
    
    &:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
  }
  
  /* 文档图片样式 */
  :deep(.document-image) {
    max-width: 100%;
    height: auto;
    display: block;
    cursor: pointer;
    transition: all 0.3s ease;
    
    &:hover {
      opacity: 0.9;
    }
    
    /* 图片加载动画 */
    &[src] {
      animation: fadeIn 0.3s ease-in;
    }
  }
  
  /* 图片信息标签 */
  :deep(.image-info) {
    padding: 8px 12px;
    background: #f8f9fa;
    border-top: 1px solid #e4e7ed;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    
    .image-label {
      color: #67c23a;
      font-weight: 500;
    }
    
    .image-url {
      color: #909399;
      font-family: 'Courier New', monospace;
      background: #e4e7ed;
      padding: 2px 6px;
      border-radius: 3px;
    }
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  /* 图片链接样式优化 */
  :deep(a[href*=".jpg"]),
  :deep(a[href*=".jpeg"]),
  :deep(a[href*=".png"]),
  :deep(a[href*=".gif"]),
  :deep(a[href*=".webp"]),
  :deep(a[href*=".svg"]) {
    color: #67c23a;
    font-weight: 500;
    
    &:before {
      content: "🖼️ ";
      margin-right: 4px;
    }
  }

  /* 设计方案页签样式 */
  .design-plan-content {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .design-header {
    margin-bottom: 16px;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #409eff;
  }

  .design-title h4 {
    margin: 0 0 8px 0;
    color: #303133;
    font-size: 18px;
    font-weight: 600;
  }

  .design-meta {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .design-time {
    color: #909399;
    font-size: 12px;
  }

  .design-actions {
    display: flex;
    align-items: center;
  }

  .design-plan-body {
    flex: 1;
    overflow: hidden;
  }

  .design-scrollbar {
    height: 100%;
  }

  .design-text {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
    color: #2c3e50;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e4e7ed;
    margin: 0;
  }

  .markdown-content {
    padding: 20px;
    background: #ffffff;
    border-radius: 8px;
    border: 1px solid #e4e7ed;
  }

  .markdown-content h1,
  .markdown-content h2,
  .markdown-content h3,
  .markdown-content h4,
  .markdown-content h5,
  .markdown-content h6 {
    color: #2c3e50;
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
  }

  .markdown-content h1 {
    font-size: 2em;
    border-bottom: 2px solid #e4e7ed;
    padding-bottom: 8px;
  }

  .markdown-content h2 {
    font-size: 1.5em;
    border-bottom: 1px solid #e4e7ed;
    padding-bottom: 6px;
  }

  .markdown-content h3 {
    font-size: 1.25em;
  }

  .markdown-content h4 {
    font-size: 1em;
  }

  .markdown-content p {
    margin-bottom: 16px;
    line-height: 1.6;
    color: #606266;
  }

  .markdown-content ul,
  .markdown-content ol {
    margin-bottom: 16px;
    padding-left: 24px;
  }

  .markdown-content li {
    margin-bottom: 8px;
    line-height: 1.6;
    color: #606266;
  }

  .markdown-content code {
    background: #f1f2f3;
    padding: 2px 4px;
    border-radius: 3px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
    color: #e74c3c;
  }

  .markdown-content pre {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 6px;
    border: 1px solid #e4e7ed;
    overflow-x: auto;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.45;
  }

  .markdown-content blockquote {
    margin: 16px 0;
    padding: 0 16px;
    border-left: 4px solid #dfe2e5;
    color: #6a737d;
  }

  .markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 16px;
  }

  .markdown-content table th,
  .markdown-content table td {
    padding: 12px;
    border: 1px solid #e4e7ed;
    text-align: left;
  }

  .markdown-content table th {
    background: #f8f9fa;
    font-weight: 600;
  }

  .design-stats {
    margin-top: 16px;
    flex-shrink: 0;
  }
}
</style> 