# 文件分析模块接口设计说明

## 概述

文件分析模块采用**多接口设计**，将文档处理流程分为5个独立的步骤，每个步骤都有对应的接口和状态管理。这种设计提供了更好的灵活性、可维护性和用户体验。

## 5个处理步骤

### 1. 文档上传 (Document Upload)
- **接口**: `POST /api/file/upload`
- **功能**: 接收文件上传，创建解析任务
- **状态**: `uploading` → `parsing`

### 2. 文档解析 (Document Parsing)
- **接口**: `GET /api/file/parsing/{task_id}` (状态查询)
- **功能**: 解析文档内容，提取文本和结构信息
- **状态**: `parsing` → `completed`

### 3. 内容分析 (Content Analysis)
- **接口**: `POST /api/file/analyze/{task_id}`
- **功能**: 分析文档结构、提取关键词、生成摘要
- **状态**: `content_analyzing` → `content_completed`

### 4. 智能分析 (AI Analysis)
- **接口**: `POST /api/file/ai-analyze/{task_id}`
- **功能**: 使用AI进行深度文档分析
- **状态**: `ai_analyzing` → `ai_completed`

### 5. 完成处理 (Completion)
- **接口**: `GET /api/file/result/{task_id}`
- **功能**: 获取完整的分析结果
- **状态**: `fully_completed`

## 接口详细设计

### 1. 文档上传接口

```http
POST /api/file/upload
Content-Type: application/json

{
  "file_info": {
    "name": "document.docx",
    "type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "size": 1024000,
    "content": "base64编码的文件内容"
  },
  "client_id": "client_12345"
}
```

**文件限制**:
- 最大文件大小: 21MB
- 支持格式: `.doc`, `.docx`, `.pdf`, `.txt`, `.md`
- 重复检查: 基于文件内容SHA256哈希值

**响应**:
```json
{
  "success": true,
  "task_id": "task_uuid",
  "message": "文件上传成功，开始解析",
  "file_path": "uploads/document_task_uuid.docx",
  "file_size": 1024000,
  "timestamp": "2025-01-15T10:30:00Z",
  "next_step": "parsing"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": "文件大小 25.0MB 超过限制，最大允许 21.0MB",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

**重复文件响应** (409 Conflict):
```json
{
  "success": false,
  "error": "文件已存在，重复上传: document.docx",
  "duplicate_task_id": "existing_task_uuid",
  "upload_time": "2025-01-15T09:30:00Z",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

## 文件管理接口

### 获取文件列表

```http
GET /api/file/list
```

**响应**:
```json
{
  "success": true,
  "files": [
    {
      "file_hash": "sha256_hash",
      "name": "document.docx",
      "path": "uploads/document_task_uuid.docx",
      "size": 1024000,
      "type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
      "upload_time": "2025-01-15T10:30:00Z",
      "task_id": "task_uuid",
      "client_id": "client_12345",
      "exists": true
    }
  ],
  "total_count": 1,
  "timestamp": "2025-01-15T10:35:00Z"
}
```

### 删除文件

```http
DELETE /api/file/delete/{task_id}
```

**响应**:
```json
{
  "success": true,
  "message": "文件 document.docx 已删除",
  "task_id": "task_uuid",
  "timestamp": "2025-01-15T10:40:00Z"
}
```

### 2. 解析状态查询接口

```http
GET /api/file/parsing/{task_id}
```

**响应**:
```json
{
  "success": true,
  "task_id": "task_uuid",
  "status": "completed",
  "progress": 100,
  "current_step": "解析完成",
  "steps": [
    {
      "step": "开始解析文件",
      "progress": 10,
      "timestamp": "2025-01-15T10:30:01Z",
      "status": "processing"
    }
  ],
  "result": {
    "type": "word",
    "text_content": "文档内容...",
    "file_name": "document.docx",
    "parsing_duration": 2.5
  },
  "next_step": "content_analysis"
}
```

### 3. 内容分析接口

```http
POST /api/file/analyze/{task_id}
```

**响应**:
```json
{
  "success": true,
  "task_id": "task_uuid",
  "message": "内容分析已开始",
  "timestamp": "2025-01-15T10:30:05Z",
  "next_step": "ai_analysis"
}
```

### 4. AI智能分析接口

```http
POST /api/file/ai-analyze/{task_id}
Content-Type: application/json

{
  "analysis_type": "comprehensive",
  "custom_prompt": "请重点分析需求的完整性"
}
```

**分析类型**:
- `comprehensive`: 全面分析
- `summary`: 摘要分析
- `requirements`: 需求分析
- `custom`: 自定义分析

**响应**:
```json
{
  "success": true,
  "task_id": "task_uuid",
  "message": "AI智能分析已开始",
  "analysis_type": "comprehensive",
  "timestamp": "2025-01-15T10:30:10Z",
  "next_step": "completion"
}
```

### 5. 完整结果获取接口

```http
GET /api/file/result/{task_id}
```

**响应**:
```json
{
  "success": true,
  "task_id": "task_uuid",
  "status": "fully_completed",
  "file_info": {
    "name": "document.docx",
    "type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "size": 1024000
  },
  "parsing_result": {
    "type": "word",
    "text_content": "文档内容...",
    "paragraph_count": 25,
    "table_count": 3
  },
  "content_analysis": {
    "document_type": "requirements",
    "language": "chinese",
    "summary": "文档摘要...",
    "keyword_extraction": [["需求", 15], ["功能", 12]],
    "structure_analysis": {
      "total_lines": 150,
      "headings": 8
    }
  },
  "ai_analysis": {
    "analysis_type": "comprehensive",
    "ai_response": "AI分析结果...",
    "confidence_score": 0.85,
    "analysis_model": "doubao-pro-4k"
  },
  "total_duration": 15.2
}
```

## 状态流转图

```
文档上传 → 文档解析 → 内容分析 → AI智能分析 → 完成处理
   ↓         ↓         ↓          ↓           ↓
uploading  parsing  content_   ai_analyzing  fully_
                   analyzing                completed
```

## WebSocket实时通知

系统通过WebSocket推送实时进度更新：

### 进度更新事件
```json
{
  "type": "file_parsing_progress",
  "task_id": "task_uuid",
  "status": "processing",
  "progress": 50,
  "current_step": "解析Word文档",
  "file_name": "document.docx",
  "timestamp": "2025-01-15T10:30:03Z"
}
```

### 完成通知事件
```json
{
  "type": "file_analysis_completed",
  "task_id": "task_uuid",
  "status": "fully_completed",
  "message": "文档分析全部完成",
  "file_name": "document.docx",
  "timestamp": "2025-01-15T10:30:15Z"
}
```

## 前端状态管理

### 状态定义
```javascript
const parsingStatus = ref('idle') // idle, uploading, parsing, content_analyzing, ai_analyzing, completed, failed
const parsingProgress = ref(0)    // 0-100
const currentParsingTask = ref(null)
```

### 处理流程
1. **文件上传**: 调用 `uploadFile()` 方法
2. **自动轮询**: 系统自动轮询各个步骤的状态
3. **进度显示**: 实时更新进度条和步骤时间线
4. **结果展示**: 完成后在"解析结果"页签显示完整结果

## 优势分析

### 多接口设计的优势

1. **灵活性**: 每个步骤可以独立调用和控制
2. **可扩展性**: 容易添加新的分析步骤
3. **错误处理**: 可以精确定位失败的步骤
4. **用户体验**: 提供详细的进度反馈
5. **性能优化**: 可以并行处理某些步骤
6. **缓存支持**: 可以缓存中间结果
7. **重试机制**: 可以针对特定步骤进行重试

### 与单接口设计的对比

| 特性 | 多接口设计 | 单接口设计 |
|------|------------|------------|
| 灵活性 | ✅ 高 | ❌ 低 |
| 进度反馈 | ✅ 详细 | ❌ 粗糙 |
| 错误定位 | ✅ 精确 | ❌ 模糊 |
| 扩展性 | ✅ 容易 | ❌ 困难 |
| 复杂度 | ⚠️ 中等 | ✅ 简单 |
| 维护性 | ✅ 好 | ❌ 差 |

## 实现特点

### 后端特点
- 异步任务处理
- 实时进度推送
- 完整的错误处理
- 支持多种文档格式
- AI分析集成

### 前端特点
- 响应式状态管理
- 实时进度显示
- 美观的结果展示
- 完整的用户反馈
- 错误状态处理

## 总结

采用多接口设计的文件分析模块提供了：

1. **完整的5步骤处理流程**
2. **实时的进度反馈机制**
3. **详细的分析结果展示**
4. **良好的用户体验**
5. **强大的扩展能力**

这种设计既满足了当前的功能需求，又为未来的功能扩展提供了良好的基础架构。 