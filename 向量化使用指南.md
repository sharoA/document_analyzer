# 知识库向量化使用指南

## 功能概述

此功能针对特定的Word文档 `LS-1(YS-72)_需求文档-链数一期V1.8.docx` 进行向量化处理，将文档内容存储到Weaviate向量数据库中，供后续的智能检索和分析使用。

## 核心特性

### 1. 🗑️ 自动清理
- 自动删除Document集合中已存在的同名文件记录
- 避免重复数据，确保数据一致性

### 2. 📄 智能文档处理
- 读取Word文档(.docx)格式
- 识别标题结构(Heading样式)
- 提取文本内容并保持层级关系

### 3. 🧠 语义分块
- 使用 `_preprocess_document` 方法进行智能分块
- 按标题层级组织内容
- 每个块包含：
  - section: 章节标题
  - content: 章节内容
  - level: 标题层级
  - embedding: 1024维向量嵌入
  - image_refs: 图片引用列表

### 4. 🔍 向量嵌入
- 使用 `BAAI/bge-large-zh` 模型(1024维)
- 针对中文文档优化
- 支持语义相似度检索

### 5. 💾 Weaviate存储
- 存储到Document集合
- 包含完整的元数据信息
- 支持批量插入，提高性能

## 数据结构

### Weaviate Schema (Document集合)

```json
{
  "content": "文档内容",
  "file_path": "文件完整路径",
  "file_name": "LS-1(YS-72)_需求文档-链数一期V1.8.docx",
  "project": "LS",
  "file_type": "docx",
  "source_type": "requirement_doc",
  "section": "章节标题",
  "chunk_index": 0,
  "created_at": "2024-01-01T00:00:00",
  "image_refs": "[]",
  "level": 1
}
```

### 向量维度
- **1024维** - 使用bge-large-zh模型
- 支持高精度语义匹配

## 使用方法

### 方法1: 直接运行脚本
```bash
cd /d/ai_project/document_analyzer
python run_vectorization.py
```

### 方法2: 在代码中调用
```python
from src.utils.knowledge_single_word_weaviate import KnowledgeBaseInitializer

# 创建初始化器
initializer = KnowledgeBaseInitializer()

# 处理指定文档
document_path = r"D:\knowledge_base\链数_LS\需求文档\LS-1(YS-72)_需求文档-链数一期V1.8.docx"
result = initializer.process_single_document(document_path)

# 检查结果
if result["success"]:
    print(f"成功处理 {result['total_chunks']} 个文档块")
else:
    print(f"处理失败: {result['error']}")

# 关闭连接
initializer.close()
```

## 处理流程

1. **✅ 环境检查**
   - 验证Weaviate连接
   - 加载嵌入模型
   - 初始化Redis缓存

2. **🗄️ 模式创建**
   - 确保Document集合存在
   - 配置向量化设置

3. **🗑️ 数据清理**
   - 查询现有同名文件记录
   - 删除旧数据避免重复

4. **📄 文档解析**
   - 读取Word文档
   - 提取文本和结构
   - 转换为markdown格式

5. **🧠 智能分块**
   - 按标题层级分割
   - 生成向量嵌入
   - 提取图片引用

6. **💾 批量存储**
   - 分批插入Weaviate
   - 记录成功/失败统计
   - 返回处理结果

## 输出示例

### 成功情况
```
🚀 开始处理文档向量化...
📄 目标文档: D:\knowledge_base\链数_LS\需求文档\LS-1(YS-72)_需求文档-链数一期V1.8.docx

🎉 文档向量化成功！
   📄 文件名: LS-1(YS-72)_需求文档-链数一期V1.8.docx
   📊 生成块数: 25
   💾 存储块数: 25
   🗄️ 集合名称: Document
```

### 失败情况
```
❌ 文档向量化失败!
   📄 文件名: LS-1(YS-72)_需求文档-链数一期V1.8.docx
   🔥 错误信息: 文件不存在: D:\knowledge_base\...
```

## 依赖要求

- Python 3.8+
- Weaviate 数据库
- Redis 缓存
- 以下Python包：
  - `python-docx`
  - `sentence-transformers`
  - `weaviate-client`
  - `langchain`

## 注意事项

1. **文件路径**: 确保文档文件存在于指定路径
2. **网络连接**: 需要访问Weaviate和Redis服务
3. **模型下载**: 首次运行会下载bge-large-zh模型
4. **内存要求**: 向量模型需要足够内存支持
5. **权限检查**: 确保有文件读取权限

## 故障排除

### 常见问题

1. **文件不存在**
   - 检查文件路径是否正确
   - 确认文件权限

2. **Weaviate连接失败**
   - 检查Weaviate服务状态
   - 验证连接配置

3. **模型加载失败**
   - 检查网络连接
   - 验证内存是否充足

4. **向量插入失败**
   - 检查数据格式
   - 验证集合Schema

## 扩展功能

此脚本可以轻松扩展支持：
- 批量处理多个文档
- 支持其他文档格式
- 自定义向量模型
- 增量更新机制

## 性能优化

- 批量插入减少网络开销
- Redis缓存避免重复计算
- 异步处理提高并发性
- 内存管理优化大文件处理 