# analyDesign 当前接口结构说明

## 📋 系统架构概述

analyDesign 采用**双服务器架构**：
- **HTTP API 服务器** (`api_server.py`) - 端口 8082
- **WebSocket 服务器** (`websocket_server.py`) - 端口 8081

支持 **RESTful API** 和 **WebSocket 实时通信** 两种交互方式。

## 🌐 HTTP API 接口 (端口 8080)

### 基础信息接口

#### 1. 服务首页
```http
GET /
```
**功能**: 获取服务基本信息和所有可用端点
**响应**:
```json
{
  "service": "analyDesign API Server",
  "version": "2.0.0",
  "status": "running",
  "timestamp": "2025-01-15T10:30:00Z",
  "endpoints": {
    "chat": "/api/chat",
    "health": "/api/health",
    "sessions": "/api/sessions",
    "file_upload": "/api/file/upload",
    "file_list": "/api/file/list",
    "file_delete": "/api/file/delete/<task_id>",
    "parsing_status": "/api/file/parsing/<task_id>",
    "content_analysis": "/api/file/analyze/<task_id>",
    "ai_analysis": "/api/file/ai-analyze/<task_id>",
    "analysis_result": "/api/file/result/<task_id>"
  },
  "features": [
    "HTTP RESTful API",
    "火山引擎 AI 集成",
    "文件上传和解析",
    "内容分析",
    "智能AI分析",
    "会话管理",
    "CORS 跨域支持"
  ]
}
```

#### 2. 健康检查
```http
GET /api/health
```
**功能**: 检查服务状态和依赖服务连接状态
**响应**:
```json
{
  "status": "healthy",
  "timestamp": "2025-01-15T10:30:00Z",
  "services": {
    "api_server": "running",
    "volcano_engine": "connected"
  }
}
```

### 聊天对话接口

#### 3. 聊天接口
```http
POST /api/chat
Content-Type: application/json
```
**请求体**:
```json
{
  "message": "用户消息内容",
  "session_id": "可选的会话ID"
}
```
**响应**:
```json
{
  "success": true,
  "response": "AI助手的回复内容",
  "session_id": "会话ID",
  "timestamp": "2025-01-15T10:30:00Z",
  "confidence": 0.9,
  "intent": "需求分析",
  "model": "ep-20250528194304-wbvcf"
}
```

### 会话管理接口

#### 4. 获取所有会话
```http
GET /api/sessions
```
**响应**:
```json
{
  "success": true,
  "sessions": {
    "session_id_1": {
      "created_at": "2025-01-15T10:00:00Z",
      "messages": [
        {
          "role": "user",
          "content": "用户消息",
          "timestamp": "2025-01-15T10:00:00Z"
        },
        {
          "role": "assistant", 
          "content": "AI回复",
          "timestamp": "2025-01-15T10:00:05Z"
        }
      ]
    }
  },
  "count": 1,
  "timestamp": "2025-01-15T10:30:00Z"
}
```

#### 5. 获取特定会话
```http
GET /api/sessions/{session_id}
```
**响应**:
```json
{
  "success": true,
  "session": {
    "created_at": "2025-01-15T10:00:00Z",
    "messages": [...]
  },
  "session_id": "session_id",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

#### 6. 删除会话
```http
DELETE /api/sessions/{session_id}
```
**响应**:
```json
{
  "success": true,
  "message": "会话已删除",
  "session_id": "session_id",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

### 文件处理接口

#### 7. 文件上传
```http
POST /api/file/upload
Content-Type: application/json
```
**请求体** (JSON格式):
```json
{
  "file_info": {
    "name": "document.docx",
    "type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "size": 1024000,
    "content": "base64编码的文件内容"
  }
}
```
**或者** (multipart/form-data格式):
```http
POST /api/file/upload
Content-Type: multipart/form-data

file: [文件二进制数据]
```
**响应**:
```json
{
  "success": true,
  "task_id": "uuid",
  "file_info": {
    "name": "document.docx",
    "type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "size": 1024000
  },
  "file_path": "uploads/uuid_document.docx",
  "message": "文件上传成功，开始解析",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

#### 8. 获取解析状态
```http
GET /api/file/parsing/{task_id}
```
**响应**:
```json
{
  "success": true,
  "task_id": "uuid",
  "status": "completed",
  "progress": 100,
  "current_step": "解析完成",
  "steps": [
    {
      "step": "开始解析文件",
      "progress": 10,
      "timestamp": "2025-01-15T10:30:01Z",
      "status": "processing"
    }
  ],
  "result": {
    "type": "word",
    "text_content": "文档内容...",
    "file_name": "document.docx",
    "parsing_duration": 2.5
  }
}
```

#### 9. 内容分析
```http
POST /api/file/analyze/{task_id}
```
**响应**:
```json
{
  "success": true,
  "task_id": "uuid",
  "message": "内容分析已开始",
  "timestamp": "2025-01-15T10:30:05Z"
}
```

#### 10. AI智能分析
```http
POST /api/file/ai-analyze/{task_id}
Content-Type: application/json
```
**请求体**:
```json
{
  "analysis_type": "comprehensive",
  "custom_prompt": "请重点分析需求的完整性"
}
```
**分析类型**:
- `comprehensive`: 全面分析
- `summary`: 摘要分析  
- `requirements`: 需求分析
- `custom`: 自定义分析

**响应**:
```json
{
  "success": true,
  "task_id": "uuid",
  "message": "AI智能分析已开始",
  "analysis_type": "comprehensive",
  "timestamp": "2025-01-15T10:30:10Z"
}
```

#### 11. 获取完整分析结果
```http
GET /api/file/result/{task_id}
```
**响应**:
```json
{
  "success": true,
  "task_id": "uuid",
  "status": "fully_completed",
  "file_info": {
    "name": "document.docx",
    "type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "size": 1024000
  },
  "parsing_result": {
    "type": "word",
    "text_content": "文档内容...",
    "paragraph_count": 25,
    "table_count": 3
  },
  "content_analysis": {
    "document_type": "requirements",
    "language": "chinese",
    "summary": "文档摘要...",
    "keyword_extraction": [["需求", 15], ["功能", 12]],
    "structure_analysis": {
      "total_lines": 150,
      "headings": 8
    }
  },
  "ai_analysis": {
    "analysis_type": "comprehensive",
    "ai_response": "AI分析结果...",
    "confidence_score": 0.85,
    "analysis_model": "doubao-pro-4k"
  },
  "total_duration": 15.2
}
```

#### 12. 获取文件列表
```http
GET /api/file/list
```
**响应**:
```json
{
  "success": true,
  "files": [
    {
      "task_id": "uuid",
      "file_info": {
        "name": "document.docx",
        "type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        "size": 1024000
      },
      "status": "fully_completed",
      "progress": 100,
      "created_at": "2025-01-15T10:30:00Z",
      "updated_at": "2025-01-15T10:30:15Z"
    }
  ],
  "count": 1,
  "timestamp": "2025-01-15T10:30:00Z"
}
```

#### 13. 删除文件
```http
DELETE /api/file/delete/{task_id}
```
**响应**:
```json
{
  "success": true,
  "message": "文件已删除",
  "task_id": "uuid",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

## 🔌 WebSocket 实时通信接口 (端口 5000)

### 连接管理事件

#### 1. 连接建立
**事件**: `connect`
**服务器响应**:
```json
{
  "status": "success",
  "client_id": "client_sid",
  "message": "连接成功",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

#### 2. 断开连接
**事件**: `disconnect`
**说明**: 客户端断开连接时触发，服务器清理连接信息

#### 3. 心跳检测
**客户端发送**: `ping`
```json
{
  "timestamp": "2025-01-15T10:30:00Z"
}
```
**服务器响应**: `pong`
```json
{
  "timestamp": "2025-01-15T10:30:00Z",
  "client_id": "client_sid"
}
```

### 聊天通信事件

#### 4. 发送聊天消息
**客户端发送**: `chat`
```json
{
  "message": "用户消息内容",
  "session_id": "可选的会话ID"
}
```

**服务器响应**: `chat_processing`
```json
{
  "session_id": "session_id",
  "message": "正在处理您的消息...",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

**服务器响应**: `chat_response`
```json
{
  "success": true,
  "response": "AI助手的回复内容",
  "session_id": "session_id",
  "timestamp": "2025-01-15T10:30:05Z",
  "confidence": 0.9,
  "intent": "需求分析",
  "model": "ep-20250528194304-wbvcf"
}
```

### 文件处理事件

#### 5. 文件上传进度
**客户端发送**: `file_upload_progress`
```json
{
  "task_id": "uuid",
  "progress": 50,
  "status": "uploading"
}
```

**服务器广播**: `file_parsing_progress`
```json
{
  "type": "file_parsing_progress",
  "task_id": "uuid",
  "status": "processing",
  "progress": 50,
  "current_step": "解析Word文档",
  "file_name": "document.docx",
  "timestamp": "2025-01-15T10:30:03Z"
}
```

#### 6. 获取状态
**客户端发送**: `get_status`
**服务器响应**: `status_update`
```json
{
  "connected_clients": 5,
  "server_status": "running",
  "volcano_engine_status": "connected",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

### 错误处理事件

#### 7. 错误通知
**服务器发送**: `error`
```json
{
  "error": "错误描述信息",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

## 📊 状态码和错误处理

### HTTP 状态码
- `200 OK`: 请求成功
- `400 Bad Request`: 请求参数错误
- `404 Not Found`: 资源不存在
- `409 Conflict`: 资源冲突（如重复上传）
- `500 Internal Server Error`: 服务器内部错误

### 错误响应格式
```json
{
  "success": false,
  "error": "错误描述信息",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

## 🔧 技术特性

### CORS 跨域支持
- 允许来源: `http://localhost:3000`, `http://127.0.0.1:3000`
- 支持方法: `GET`, `POST`, `PUT`, `DELETE`, `OPTIONS`
- 支持头部: `Content-Type`, `Authorization`
- 支持凭证: `true`

### 文件上传限制
- 最大文件大小: **21MB**
- 支持格式: `.doc`, `.docx`, `.pdf`, `.txt`, `.md`
- 编码方式: `base64` (JSON) 或 `multipart/form-data`

### 火山引擎集成
- 模型: `ep-20250528194304-wbvcf` (doubao-pro-4k)
- 默认温度: `0.7`
- 最大Token: `2000`
- 支持流式和非流式响应

### 日志记录
- 按天轮转日志文件
- 双格式记录 (文本 + JSON)
- 完整的请求-响应生命周期记录
- 详细的错误和性能统计

## 🚀 启动方式

### HTTP API 服务器
```bash
python -m src.api_server
# 或
python run.py
```
**访问地址**: http://localhost:8080

### WebSocket 服务器
```bash
python -m src.websocket_server
```
**访问地址**: http://localhost:5000

### 集成启动
```bash
python start_integrated_server.py
```
**同时启动两个服务器**

---

**总结**: analyDesign 提供了完整的 RESTful API 和 WebSocket 实时通信接口，支持聊天对话、文件处理、会话管理等核心功能，具备良好的错误处理、跨域支持和日志记录能力。 